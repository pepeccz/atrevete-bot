# BMAD: Chatwoot API URL Trailing Slash Fix

**Story:** 1.5 - Basic LangGraph State & Echo Bot
**Date:** 2025-10-28
**Severity:** High (Blocking outbound messages)
**Status:** ✅ Resolved

---

## Behavior

### Observed Symptoms

After fixing the AsyncRedisSaver initialization (see `1.5a` and `1.5b`), the agent successfully processed incoming messages and generated responses, but failed to send them back to customers via Chatwoot:

**Agent Logs:**
```json
{"timestamp": "2025-10-27T23:03:14.601035+00:00", "level": "INFO", "logger": "__main__", "message": "Message received: conversation_id=3, phone=+34623226544"}
{"timestamp": "2025-10-27T23:03:14.643707+00:00", "level": "INFO", "logger": "agent.nodes.greeting", "message": "Greeting sent for conversation_id=3"}
{"timestamp": "2025-10-27T23:03:14.677545+00:00", "level": "INFO", "logger": "__main__", "message": "Graph completed for conversation_id=3"}
{"timestamp": "2025-10-27T23:03:14.683049+00:00", "level": "INFO", "logger": "__main__", "message": "Message published to outgoing_messages: conversation_id=3"}
{"timestamp": "2025-10-27T23:03:14.683639+00:00", "level": "INFO", "logger": "__main__", "message": "Outgoing message received: conversation_id=3, phone=+34623226544"}
{"timestamp": "2025-10-27T23:03:14.684231+00:00", "level": "INFO", "logger": "agent.tools.notification_tools", "message": "Sending message to +34623226544"}
```

✅ **Up to this point, everything worked perfectly.**

**Then the error:**
```json
{"timestamp": "2025-10-27T23:03:15.640671+00:00", "level": "INFO", "logger": "httpx", "message": "HTTP Request: POST https://zanovixagency-chatwoot.g0evis.easypanel.host//api/v1/accounts/1/conversations \"HTTP/1.1 404 Not Found\""}
                                                                                                    ^^
                                                                                            Double slash!

{"timestamp": "2025-10-27T23:03:15.642172+00:00", "level": "ERROR", "logger": "agent.tools.notification_tools", "message": "HTTP error managing conversation: Client error '404 Not Found' for url 'https://zanovixagency-chatwoot.g0evis.easypanel.host//api/v1/accounts/1/conversations'"}
```

After 3 retry attempts:
```json
{"timestamp": "2025-10-27T23:03:20.407534+00:00", "level": "ERROR", "logger": "agent.tools.notification_tools", "message": "Failed to send message to +34623226544 after retries: Client error '404 Not Found'"}
{"timestamp": "2025-10-27T23:03:20.417653+00:00", "level": "ERROR", "logger": "__main__", "message": "Message sent to +34623226544: success=False"}
```

### User Impact

- **High:** Customer messages received but no responses sent
- **Symptoms:** LangGraph processing works perfectly, but outbound message delivery fails with 404
- **Root Cause:** Double slash (`//`) in Chatwoot API URLs causing 404 errors

### Analysis

**Correct URL:**
```
https://zanovixagency-chatwoot.g0evis.easypanel.host/api/v1/accounts/1/conversations
                                                    ^
```

**Generated URL (incorrect):**
```
https://zanovixagency-chatwoot.g0evis.easypanel.host//api/v1/accounts/1/conversations
                                                    ^^
                                                  Double slash
```

**Why this happened:**

1. `.env` configuration included trailing slash:
   ```bash
   CHATWOOT_API_URL=https://zanovixagency-chatwoot.g0evis.easypanel.host/
                                                                         ^
   ```

2. Code concatenated path without normalization:
   ```python
   f"{self.api_url}/api/v1/accounts/{self.account_id}/conversations"
   ```

3. Result: `https://.../` + `/api/...` = `https://...//api/...`

---

## Measure

### Before Fix - Environment Configuration

**Environment Variable:**
```bash
CHATWOOT_API_URL=https://zanovixagency-chatwoot.g0evis.easypanel.host/
                                                                       ^ trailing slash
```

**Verification:**
```bash
$ docker exec atrevete-agent python3 -c "from shared.config import get_settings; s = get_settings(); print(f'CHATWOOT_API_URL: {repr(s.CHATWOOT_API_URL)}')"

CHATWOOT_API_URL: 'https://zanovixagency-chatwoot.g0evis.easypanel.host/'
```

### Before Fix - Code

**File:** `agent/tools/notification_tools.py:32-46`

```python
def __init__(self):
    """Initialize Chatwoot client with credentials from settings."""
    settings = get_settings()
    self.api_url = settings.CHATWOOT_API_URL  # ❌ No normalization
    self.api_token = settings.CHATWOOT_API_TOKEN
    self.account_id = settings.CHATWOOT_ACCOUNT_ID
    self.inbox_id = settings.CHATWOOT_INBOX_ID

    self.headers = {
        "api_access_token": self.api_token,
        "Content-Type": "application/json",
    }

    logger.info(f"ChatwootClient initialized: {self.api_url}, account_id={self.account_id}")
```

**URL Construction (all endpoints affected):**

```python
# Line 67 - Contact search
f"{self.api_url}/api/v1/accounts/{self.account_id}/contacts/search"

# Line 102 - Create contact
f"{self.api_url}/api/v1/accounts/{self.account_id}/contacts"

# Line 148 - Get contact details
f"{self.api_url}/api/v1/accounts/{self.account_id}/contacts/{contact_id}"

# Line 165 - Create conversation (FAILING)
f"{self.api_url}/api/v1/accounts/{self.account_id}/conversations"

# Line 229 - Send message
f"{self.api_url}/api/v1/accounts/{self.account_id}/conversations/{conversation_id}/messages"
```

**All endpoints would have double slash if `CHATWOOT_API_URL` ends with `/`**

### Evidence of 404 Errors

**HTTP Request Log:**
```
HTTP Request: GET https://zanovixagency-chatwoot.g0evis.easypanel.host//api/v1/accounts/1/contacts/search?q=%2B34623226544 "HTTP/1.1 200 OK"
```

**Interesting observation:** The `GET` endpoints (contact search, get contact) returned **200 OK** despite the double slash, but `POST` endpoint returned **404 Not Found**. This suggests:
- Some web servers/frameworks tolerate double slashes in GET requests
- POST requests are more strict about URL paths
- This is a Chatwoot API server behavior

---

## Act

### Solution Implemented

**Strategy:** Normalize the API URL by removing trailing slash in `__init__` method.

**File:** `agent/tools/notification_tools.py:32-47`

```python
def __init__(self):
    """Initialize Chatwoot client with credentials from settings."""
    settings = get_settings()
    # ✅ Remove trailing slash to avoid double slashes in URLs
    self.api_url = settings.CHATWOOT_API_URL.rstrip("/")
    self.api_token = settings.CHATWOOT_API_TOKEN
    self.account_id = settings.CHATWOOT_ACCOUNT_ID
    self.inbox_id = settings.CHATWOOT_INBOX_ID

    # Set up HTTP client with authentication headers
    self.headers = {
        "api_access_token": self.api_token,
        "Content-Type": "application/json",
    }

    logger.info(f"ChatwootClient initialized: {self.api_url}, account_id={self.account_id}")
```

**Key Change:**
```python
# Before:
self.api_url = settings.CHATWOOT_API_URL

# After:
self.api_url = settings.CHATWOOT_API_URL.rstrip("/")
```

**Why `rstrip("/")` is safe:**
- If URL has trailing slash → removes it
- If URL has no trailing slash → unchanged
- Handles multiple trailing slashes: `"https://example.com///"` → `"https://example.com"`
- Does NOT affect protocol slashes: `"https://"` remains intact

### Deployment

```bash
# Rebuild agent with fix
docker compose build agent

# Deploy updated agent
docker compose up -d agent

# Verify initialization log
docker compose logs agent --tail 15 | grep "ChatwootClient initialized"
```

### Validation Results

**After Fix - Initialization Log:**
```json
{"timestamp": "2025-10-27T23:11:05.228575+00:00", "level": "INFO", "logger": "agent.tools.notification_tools", "message": "ChatwootClient initialized: https://zanovixagency-chatwoot.g0evis.easypanel.host, account_id=1"}
                                                                                                                                                                      ^
                                                                                                                                                         No trailing slash
```

**Before Fix:**
```
ChatwootClient initialized: https://zanovixagency-chatwoot.g0evis.easypanel.host/, account_id=1
                                                                                   ^
                                                                              Had trailing slash
```

**Next Step:** Manual test with real WhatsApp message to verify end-to-end flow.

---

## Document

### Lessons Learned

1. **URL Configuration Hygiene:** Always normalize base URLs by removing trailing slashes when concatenating paths. Different API servers handle double slashes differently (some tolerate GET, but reject POST).

2. **HTTP Method Differences:** The same malformed URL can behave differently based on HTTP method. GET requests with double slashes may succeed while POST requests fail with 404.

3. **Environment Variable Validation:** Consider adding validation/normalization at the settings level rather than in individual clients.

4. **Defensive Coding:** When concatenating URL parts, always normalize to prevent subtle bugs from environment configuration.

### Knowledge Base

**Pattern:** URL Normalization in API Clients

**Recommended Implementation:**

```python
class APIClient:
    def __init__(self):
        settings = get_settings()
        # Remove trailing slash from base URL
        self.base_url = settings.API_URL.rstrip("/")

    def _build_url(self, path: str) -> str:
        # Ensure path starts with slash
        if not path.startswith("/"):
            path = f"/{path}"
        return f"{self.base_url}{path}"

# Usage:
client = APIClient()
url = client._build_url("/api/v1/resource")  # Always correct
url = client._build_url("api/v1/resource")   # Also works
```

**Alternative:** Use `urllib.parse.urljoin()`
```python
from urllib.parse import urljoin

base = "https://example.com/"
path = "/api/v1/resource"
url = urljoin(base, path)  # Handles slashes correctly
# Result: "https://example.com/api/v1/resource"
```

### Testing Strategy

**Test Cases for URL Normalization:**
```python
def test_url_normalization():
    # Test trailing slash removal
    assert normalize_url("https://example.com/") == "https://example.com"
    assert normalize_url("https://example.com") == "https://example.com"

    # Test multiple trailing slashes
    assert normalize_url("https://example.com///") == "https://example.com"

    # Test path concatenation
    base = normalize_url("https://example.com/")
    path = "/api/v1/resource"
    assert f"{base}{path}" == "https://example.com/api/v1/resource"
```

### Environment Variable Best Practices

**`.env.example` Documentation:**
```bash
# Chatwoot API Configuration
# IMPORTANT: Do NOT include trailing slash
CHATWOOT_API_URL=https://your-chatwoot-instance.com
#                                                  ^ No trailing slash

# ❌ INCORRECT:
# CHATWOOT_API_URL=https://your-chatwoot-instance.com/

CHATWOOT_API_TOKEN=your_api_token_here
CHATWOOT_ACCOUNT_ID=1
CHATWOOT_INBOX_ID=1
```

**Settings Validation (Future Enhancement):**
```python
from pydantic import Field, field_validator

class Settings(BaseSettings):
    CHATWOOT_API_URL: str

    @field_validator("CHATWOOT_API_URL")
    @classmethod
    def normalize_api_url(cls, v: str) -> str:
        """Remove trailing slash from API URL."""
        return v.rstrip("/")
```

### Related Issues

- **Issue 1.5a:** AsyncRedisSaver async context manager pattern
- **Issue 1.5b:** Redis Stack requirement (RedisSearch)
- **Issue 1.4c:** Chatwoot webhook payload structure
- **Story 1.5 AC #11:** Manual test with real WhatsApp message (pending validation)

### Prevention

**Code Review Checklist:**
- [ ] Base URLs normalized by removing trailing slashes
- [ ] URL concatenation doesn't create double slashes
- [ ] Environment variables documented with format requirements
- [ ] API client URL construction tested with various base URL formats

**CI/CD Integration (Future):**
```python
# Add to integration tests
def test_chatwoot_client_url_construction():
    """Verify ChatwootClient builds correct URLs."""
    client = ChatwootClient()

    # Should not have double slashes
    test_urls = [
        f"{client.api_url}/api/v1/accounts/1/contacts",
        f"{client.api_url}/api/v1/accounts/1/conversations",
    ]

    for url in test_urls:
        assert "//" not in url.replace("https://", ""), \
            f"Double slash found in URL: {url}"
```

---

**Resolution Time:** ~15 minutes (investigation, fix, deployment, validation)
**Related Files:** `agent/tools/notification_tools.py:36`
**Impact:** High - Blocks all outbound message delivery
**Downstream Dependencies:** Requires manual test to validate full end-to-end flow

**References:**
- Python string methods: `str.rstrip()`
- URL handling: `urllib.parse.urljoin()`
- Pydantic field validators for automatic normalization
