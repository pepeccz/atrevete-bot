# BMAD: PostgreSQL System Dependencies

**Story:** 1.1 - Project Structure & Dependencies, 1.2 - Docker Compose
**Date:** 2025-10-28
**Severity:** Low (Necessary addition)
**Status:** ✅ Implemented, required for database connectivity

---

## Behavior

### Observed Addition

**Original Specification**:
- Story 1.2 Dockerfiles: Basic Python image setup
- No mention of system-level dependencies

**Implemented**:
Both Dockerfiles include PostgreSQL development libraries:

**Files**: `docker/Dockerfile.api:12-16`, `docker/Dockerfile.agent:12-16`
```dockerfile
FROM python:3.12-slim

# Install system dependencies
RUN apt-get update && apt-get install -y \
    libpq-dev \
    gcc \
    curl \
    && rm -rf /var/lib/apt/lists/*
```

---

## Measure

### Why These Dependencies Are Required

**libpq-dev** (PostgreSQL C library headers):
- Required by `psycopg` (psycopg2/psycopg3) for database connectivity
- Required by `asyncpg` for async PostgreSQL operations
- Compilation dependency for Python PostgreSQL adapters

**gcc** (GNU Compiler Collection):
- Compiles C extensions for `asyncpg`
- Compiles wheel packages without prebuilt binaries
- Required for `psycopg` compilation

**curl** (API only):
- Used in health check: `curl -f http://localhost:8000/health`
- Not needed in agent container (Python-based health check)

### Without These Dependencies

**Error Without libpq-dev**:
```bash
$ docker build -f docker/Dockerfile.api .
# During pip install asyncpg:
ERROR: Could not find pg_config executable
  Please add the directory containing pg_config to the PATH
  or specify the full executable path with the option:
      python setup.py build_ext --pg-config /path/to/pg_config build ...
```

**Error Without gcc**:
```bash
$ pip install asyncpg
# During wheel build:
error: command 'gcc' failed: No such file or directory
```

---

## Act

### Implementation Details

**Dockerfile Pattern** (both API and Agent):
```dockerfile
# Stage 1: Install system deps
FROM python:3.12-slim
RUN apt-get update && apt-get install -y \
    libpq-dev \
    gcc \
    curl \  # API only
    && rm -rf /var/lib/apt/lists/*  # Clean up to reduce image size

# Stage 2: Install Python deps
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Stage 3: Copy application code
COPY . /app
```

**Image Size Impact**:
- Base `python:3.12-slim`: ~125MB
- With libpq-dev + gcc: ~145MB (+20MB)
- Trade-off: Acceptable for database connectivity

**Alternative Considered**: Multi-stage build
```dockerfile
# Build stage (with gcc)
FROM python:3.12-slim AS builder
RUN apt-get install -y gcc libpq-dev
RUN pip install --user -r requirements.txt

# Runtime stage (without gcc)
FROM python:3.12-slim
COPY --from=builder /root/.local /root/.local
RUN apt-get install -y libpq-dev  # Still needed at runtime
```
**Decision**: Single-stage simpler, size difference minimal

---

## Document

### Lessons Learned

1. **Python C Extensions Need System Libraries**: Python database adapters often require C libraries for performance

2. **Document System Dependencies**: These aren't obvious from `requirements.txt`, need explicit documentation

3. **Clean Up Package Lists**: `rm -rf /var/lib/apt/lists/*` reduces image size

### Knowledge Base

**PostgreSQL Connectivity Requirements**:
```dockerfile
# Minimum for PostgreSQL Python libraries
RUN apt-get update && apt-get install -y \
    libpq-dev \   # PostgreSQL C library
    gcc \         # Compiler for C extensions
    && rm -rf /var/lib/apt/lists/*
```

**Python Packages Requiring These**:
- `psycopg` (synchronous PostgreSQL adapter)
- `psycopg2` (legacy adapter)
- `asyncpg` (async PostgreSQL adapter) ✅ Used in Epic 1
- `sqlalchemy` with PostgreSQL dialect

### Testing Strategy

**Validation**:
```bash
# Verify database connectivity works
$ docker exec atrevete-api python -c "import asyncpg; print('OK')"
OK

$ docker exec atrevete-agent python -c "import asyncpg; print('OK')"
OK
```

**Image Size Monitoring** (Epic 7):
```bash
$ docker images | grep atrevete
atrevete-api    latest    145MB
atrevete-agent  latest    147MB
```

### Related Issues

- **Story 1.2 AC#2**: "Data service (PostgreSQL)" → API/Agent need to connect
- **Story 1.3a**: Database models use asyncpg via SQLAlchemy
- **Epic 2+**: All database operations depend on these libraries

### Prevention

**Going Forward**:
- Document system dependencies in Dockerfile comments
- Add to `docs/architecture/deployment-architecture.md`
- Consider multi-stage builds if image size >500MB

---

**Resolution Time**: N/A (discovered during initial Docker build)
**Related Files**: `docker/Dockerfile.api`, `docker/Dockerfile.agent`
**Impact**: Necessary - Database connectivity impossible without these
**Epic 2+ Readiness**: ✅ Ready, infrastructure solid

**References**:
- libpq-dev package: https://packages.debian.org/sid/libpq-dev
- asyncpg installation: https://github.com/MagicStack/asyncpg#installation
- Docker best practices: Clean up apt lists to reduce image size
