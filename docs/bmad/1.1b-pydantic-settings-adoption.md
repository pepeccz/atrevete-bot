# BMAD: Pydantic Settings Adoption

**Story:** 1.1 - Project Structure & Dependencies
**Date:** 2025-10-28
**Severity:** Low (Positive improvement)
**Status:** ✅ Implemented, superior choice

---

## Behavior

### Observed Deviation

**Original Specification**:
- Architecture document mentioned configuration management
- No specific library mandated
- Common pattern: python-decouple for .env loading

**Implemented**:
- Pydantic Settings v2.10+ for configuration
- Type-validated settings with BaseSettings
- Nested configuration support

**File**: `shared/config.py`

---

## Measure

### Comparison: python-decouple vs Pydantic Settings

| Feature | python-decouple | Pydantic Settings | Winner |
|---------|-----------------|-------------------|--------|
| Type validation | ❌ Manual | ✅ Automatic | Pydantic |
| Nested config | ❌ Flat only | ✅ Supported | Pydantic |
| IDE support | ⚠️ Limited | ✅ Full autocomplete | Pydantic |
| Default values | ✅ Yes | ✅ Yes | Tie |
| .env loading | ✅ Yes | ✅ Yes | Tie |
| Validation errors | ❌ Runtime | ✅ Startup (fail fast) | Pydantic |
| Documentation | ⚠️ Good | ✅ Excellent | Pydantic |

### Implementation Evidence

**File**: `shared/config.py:1-60`
```python
from pydantic_settings import BaseSettings, SettingsConfigDict

class Settings(BaseSettings):
    model_config = SettingsConfigDict(
        env_file=".env",
        env_file_encoding="utf-8",
        extra="ignore",
    )

    # Database
    DATABASE_URL: str
    POSTGRES_DB: str = "atrevete_db"
    POSTGRES_USER: str = "atrevete"
    POSTGRES_PASSWORD: str

    # Redis
    REDIS_URL: str = "redis://redis:6379/0"

    # Chatwoot
    CHATWOOT_API_URL: str
    CHATWOOT_API_TOKEN: str
    CHATWOOT_ACCOUNT_ID: int
    CHATWOOT_INBOX_ID: int
    CHATWOOT_WEBHOOK_TOKEN: str
    CHATWOOT_TEAM_GROUP_ID: int | None = None

    # Anthropic
    ANTHROPIC_API_KEY: str

    # ... 20+ more settings with types

@lru_cache
def get_settings() -> Settings:
    return Settings()
```

**Benefits Realized**:
1. ✅ Type validation: `CHATWOOT_ACCOUNT_ID: int` ensures integer
2. ✅ IDE autocomplete: `settings.ANTHROPIC_API_KEY` fully typed
3. ✅ Startup validation: Missing required vars fail at startup (not runtime)
4. ✅ Optional fields: `CHATWOOT_TEAM_GROUP_ID: int | None = None`

---

## Act

### Decision Rationale

**Why Pydantic Settings Won**:

1. **Type Safety Alignment** (Story 1.7):
   - Epic 1 achieved 0 mypy errors
   - Pydantic Settings provides full type safety for config
   - python-decouple returns `str`, requires manual casting

2. **Developer Experience**:
   - IDE autocomplete on all settings
   - Validation errors at startup (fail fast)
   - Self-documenting code (types = documentation)

3. **Epic 2+ Requirements**:
   - Epic 2 Story 2.4 (Maite Prompt) needs complex config
   - Epic 3 (Calendar API) needs nested Google config
   - Pydantic Settings scales better for complex configs

4. **Integration with FastAPI**:
   - FastAPI uses Pydantic models natively
   - Consistent pattern across codebase

### Implementation

**Migration Path** (N/A, Pydantic used from start):
```bash
# Install
pip install pydantic-settings

# Usage
from shared.config import get_settings
settings = get_settings()
print(settings.ANTHROPIC_API_KEY)  # Fully typed
```

**Validation Example**:
```bash
# Missing required var
$ export DATABASE_URL=""
$ python -m api.main
# Error: Field required [type=missing, input_value={}]
#   For field: DATABASE_URL
```

---

## Document

### Lessons Learned

1. **Type Safety Everywhere**: Applying type safety to configuration prevents entire class of bugs

2. **Fail Fast**: Startup validation catches config errors before processing any messages

3. **IDE Support Matters**: Autocomplete on settings saves time, prevents typos

### Knowledge Base

**Recommended Pattern for Epic 2+**:
```python
from pydantic_settings import BaseSettings

class Settings(BaseSettings):
    # Always specify types
    API_KEY: str
    PORT: int = 8000  # Default value
    DEBUG: bool = False

    # Optional fields
    OPTIONAL_FEATURE: str | None = None

    # Nested config (Epic 3+)
    class GoogleCalendarConfig(BaseSettings):
        CLIENT_ID: str
        CLIENT_SECRET: str

    google: GoogleCalendarConfig | None = None
```

**Environment Variable Naming**:
- Use SCREAMING_SNAKE_CASE
- Prefix with service name for clarity: `API_PORT`, `AGENT_WORKERS`
- Document in `.env.example` with comments

### Testing Strategy

**Current Coverage**:
- Settings loading tested in integration tests
- Type validation tested implicitly (CI/CD fails if types wrong)

**Epic 7 Consideration**:
```python
def test_settings_validation():
    """Verify settings validation fails for invalid types."""
    with pytest.raises(ValidationError):
        Settings(CHATWOOT_ACCOUNT_ID="not_an_int")
```

### Related Issues

- **Story 1.1 AC#5**: `.env.example` template created
- **Story 1.7**: Type safety includes settings
- **Epic 2 Story 2.4**: Complex Maite prompt config

### Prevention

**Going Forward**:
- Document Pydantic Settings choice in Architecture
- Add to `docs/architecture/tech-stack.md`
- Create settings guidelines in coding standards

---

**Resolution Time**: N/A (decision made during Story 1.1)
**Related Files**: `shared/config.py`, `requirements.txt:pydantic-settings`
**Impact**: Positive - Type safety, better DX, scales for Epic 2+
**Epic 2+ Readiness**: ✅ Ready, excellent foundation

**References**:
- Pydantic Settings docs: https://docs.pydantic.dev/latest/concepts/pydantic_settings/
- FastAPI settings: https://fastapi.tiangolo.com/advanced/settings/
- Type-safe config pattern: Industry best practice
