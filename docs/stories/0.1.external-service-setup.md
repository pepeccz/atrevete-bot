# Story 0.1: External Service Account Setup

## Status
Done

## Story
**As a** developer,
**I want** all external service accounts created and API credentials obtained before starting development,
**so that** I can configure the application with real API keys and test integrations immediately.

## Acceptance Criteria

1. **Google Calendar API Setup:**
   - Google Cloud project created (e.g., "atrevete-bot-production")
   - Google Calendar API enabled in project
   - Service account created with name "atrevete-bot-calendar-service"
   - Service account granted domain-wide delegation for Calendar API scopes
   - Service account JSON key file downloaded and stored securely
   - Service account email documented in setup guide

2. **Stripe Account Setup:**
   - Stripe account created (business account recommended)
   - Test mode API keys obtained (publishable key + secret key)
   - Production API keys obtained and stored securely (separate from test keys)
   - Webhook endpoint placeholder configured (will be updated in Story 7.5 with production URL)
   - Stripe API version documented (default to latest stable)

3. **Chatwoot Setup:**
   - Chatwoot instance deployed (self-hosted recommended) OR Chatwoot Cloud account created
   - WhatsApp channel configured and connected
   - Chatwoot API access token generated with full permissions
   - Chatwoot account ID and inbox ID documented
   - Team WhatsApp group created for escalations and group conversation ID obtained

4. **Anthropic Claude API Setup:**
   - Anthropic account created at console.anthropic.com
   - API key generated with appropriate usage limits
   - Billing configured (pay-as-you-go or credits)
   - API key tier documented (free tier vs paid)

5. **Environment Configuration:**
   - `.env.example` updated with all API keys as placeholders
   - Each API key entry includes comment with acquisition URL
   - Example: `GOOGLE_SERVICE_ACCOUNT_JSON=/path/to/key.json   Get from: https://console.cloud.google.com/iam-admin/serviceaccounts`
   - Secure storage location defined for production credentials (e.g., `.env.production`, Docker secrets)

6. **Documentation:**
   - Setup guide created: `docs/external-services-setup.md`
   - Guide includes step-by-step instructions with screenshots for each service
   - Links to official documentation for each service
   - Troubleshooting section for common setup issues
   - Estimated time per service documented (Google: 15min, Stripe: 10min, Chatwoot: 30min, Anthropic: 5min)

7. **Validation:**
   - All API keys tested with simple "hello world" requests (e.g., `curl` to Stripe API, test Calendar API list events)
   - Chatwoot webhook test message sent and received successfully
   - Claude API test completion generated successfully
   - All credentials stored in secure location (NOT committed to git)

8. **Service Account Permissions (Google Calendar):**
   - Domain-wide delegation configured with scopes: `https://www.googleapis.com/auth/calendar`, `https://www.googleapis.com/auth/calendar.events`
   - Service account granted access to all 5 stylist Google Calendars
   - Test calendar event creation validated across all stylist calendars

9. **Stripe Webhook Configuration:**
   - Webhook signing secret obtained and documented
   - Event types to listen for documented: `checkout.session.completed`, `charge.refunded`
   - Test webhook sent to temporary endpoint (webhook.site or ngrok) to validate signature

10. **Team Access:**
    - All API keys shared with development team via secure method (password manager, encrypted file, secrets management tool)
    - Access permissions documented (who has access to production vs test keys)

## Tasks / Subtasks

- [ ] **Task 1: Create Google Cloud Project & Calendar API Service Account** (AC: 1, 8)
  - [ ] Navigate to https://console.cloud.google.com and create new project "atrevete-bot-production"
  - [ ] Enable Google Calendar API via APIs & Services → Library
  - [ ] Create service account: IAM & Admin → Service Accounts → Create Service Account
  - [ ] Name: "atrevete-bot-calendar-service", Description: "Calendar access for Atrévete Bot"
  - [ ] Grant service account role: "Service Account User"
  - [ ] Create and download JSON key file, store in secure location (NOT in git)
  - [ ] Configure domain-wide delegation with scopes:
    - `https://www.googleapis.com/auth/calendar`
    - `https://www.googleapis.com/auth/calendar.events`
  - [ ] Grant service account access to all 5 stylist Google Calendars (share calendar with service account email)
  - [ ] Test calendar access using Google Calendar API Quick Start or `curl` with service account credentials
  - [ ] Validate by creating a test event in one stylist calendar
  - [ ] Document service account email in setup guide

- [ ] **Task 2: Create Stripe Account & Configure Webhooks** (AC: 2, 9)
  - [ ] Create Stripe account at https://stripe.com (use business email)
  - [ ] Navigate to Developers → API keys
  - [ ] Copy Test mode keys: Publishable key (starts with `pk_test_`) and Secret key (starts with `sk_test_`)
  - [ ] Obtain Production keys once ready: Publishable key (`pk_live_`) and Secret key (`sk_live_`)
  - [ ] Navigate to Developers → Webhooks → Add endpoint
  - [ ] Configure temporary webhook endpoint (use webhook.site or ngrok for testing)
  - [ ] Select event types: `checkout.session.completed`, `charge.refunded`
  - [ ] Copy webhook signing secret (starts with `whsec_`)
  - [ ] Test webhook by sending test event via Stripe Dashboard
  - [ ] Validate signature using Stripe CLI or webhook.site inspection
  - [ ] Document Stripe API version (check Developers → API version)
  - [ ] Store all keys securely, separate test from production keys

- [ ] **Task 3: Deploy Chatwoot & Configure WhatsApp Channel** (AC: 3)
  - [ ] Choose deployment method: Self-hosted (Docker) or Chatwoot Cloud
  - [ ] If self-hosted: Follow https://www.chatwoot.com/docs/self-hosted/deployment/docker
  - [ ] If cloud: Create account at https://app.chatwoot.com
  - [ ] Navigate to Settings → Inboxes → Add Inbox → WhatsApp
  - [ ] Follow WhatsApp Business API setup (may require Meta Business Manager)
  - [ ] Configure webhook URL placeholder (will be updated in Story 1.4 with actual endpoint)
  - [ ] Navigate to Settings → Profile → Access Token → Generate new token
  - [ ] Copy API access token and document
  - [ ] Document Chatwoot Account ID (found in URL: `/app/accounts/{ACCOUNT_ID}/`)
  - [ ] Document Inbox ID (found in Inbox settings)
  - [ ] Create team WhatsApp group for escalations
  - [ ] Add bot/staff members to group
  - [ ] Document group conversation ID (available via Chatwoot API or UI)
  - [ ] Test webhook: Send test WhatsApp message and verify receipt in Chatwoot

- [ ] **Task 4: Create Anthropic Account & Obtain API Key** (AC: 4)
  - [ ] Navigate to https://console.anthropic.com and create account
  - [ ] Complete account verification if required
  - [ ] Navigate to API Keys section
  - [ ] Generate new API key with descriptive name: "atrevete-bot-production"
  - [ ] Copy API key (starts with `sk-ant-`)
  - [ ] Configure billing: Navigate to Billing → Set up payment method
  - [ ] Choose plan: Free tier (limited) or pay-as-you-go (recommended)
  - [ ] Set usage limits if available (budget protection)
  - [ ] Document API key tier and usage limits in setup guide
  - [ ] Test API key with simple completion request:
    ```bash
    curl https://api.anthropic.com/v1/messages \
      -H "x-api-key: $ANTHROPIC_API_KEY" \
      -H "anthropic-version: 2023-06-01" \
      -H "content-type: application/json" \
      -d '{"model":"claude-sonnet-4-20250514","max_tokens":100,"messages":[{"role":"user","content":"Hello"}]}'
    ```
  - [ ] Verify successful response from Claude API

- [x] **Task 5: Create .env.example Template** (AC: 5)
  - [x] Create `.env.example` file in project root
  - [x] Add Google Calendar API variables with comments:
    ```bash
    # Google Calendar API - Get from: https://console.cloud.google.com/iam-admin/serviceaccounts
    GOOGLE_SERVICE_ACCOUNT_JSON=/path/to/service-account-key.json
    GOOGLE_CALENDAR_IDS=calendar1@group.calendar.google.com,calendar2@group.calendar.google.com,calendar3@group.calendar.google.com,calendar4@group.calendar.google.com,calendar5@group.calendar.google.com
    ```
  - [x] Add Stripe variables with comments:
    ```bash
    # Stripe Payment API - Get from: https://dashboard.stripe.com/apikeys
    STRIPE_SECRET_KEY=sk_test_your_test_secret_key_here
    STRIPE_PUBLISHABLE_KEY=pk_test_your_test_publishable_key_here
    STRIPE_WEBHOOK_SECRET=whsec_your_webhook_signing_secret_here
    STRIPE_API_VERSION=2024-11-20.acacia  # Or latest stable version
    ```
  - [x] Add Chatwoot variables with comments:
    ```bash
    # Chatwoot API - Get from: https://app.chatwoot.com/app/accounts/{account_id}/settings/profile
    CHATWOOT_API_URL=https://app.chatwoot.com  # Or self-hosted URL
    CHATWOOT_API_TOKEN=your_api_access_token_here
    CHATWOOT_ACCOUNT_ID=12345
    CHATWOOT_INBOX_ID=67890
    CHATWOOT_TEAM_GROUP_ID=conversation_id_for_team_group
    ```
  - [x] Add Anthropic variables with comments:
    ```bash
    # Anthropic Claude API - Get from: https://console.anthropic.com/settings/keys
    ANTHROPIC_API_KEY=sk-ant-your_api_key_here
    ```
  - [x] Add database and Redis placeholders (will be configured in Story 1.2):
    ```bash
    # Database (configured in Story 1.2)
    DATABASE_URL=postgresql+asyncpg://user:password@localhost:5432/atrevete_bot

    # Redis (configured in Story 1.2)
    REDIS_URL=redis://localhost:6379/0
    ```
  - [x] Add application settings:
    ```bash
    # Application Settings
    TIMEZONE=Europe/Madrid
    LOG_LEVEL=INFO
    ```
  - [x] Ensure `.env.example` contains NO actual credentials, only placeholders

- [x] **Task 6: Create Setup Documentation Guide** (AC: 6)
  - [x] Create `docs/external-services-setup.md` file
  - [x] Write introduction explaining purpose and prerequisites
  - [x] Add section 1: Google Calendar API Setup (15 min estimated)
    - Step-by-step instructions with screenshots
    - Link to official docs: https://developers.google.com/calendar/api/quickstart/python
    - Troubleshooting: Common errors (403 Forbidden, service account permissions)
  - [x] Add section 2: Stripe Account Setup (10 min estimated)
    - Step-by-step instructions with screenshots
    - Link to official docs: https://stripe.com/docs/keys
    - Troubleshooting: Test mode vs live mode confusion
  - [x] Add section 3: Chatwoot Setup (30 min estimated)
    - Step-by-step instructions for self-hosted and cloud options
    - Link to official docs: https://www.chatwoot.com/docs/
    - Troubleshooting: WhatsApp Business API approval delays
  - [x] Add section 4: Anthropic Claude API Setup (5 min estimated)
    - Step-by-step instructions
    - Link to official docs: https://docs.anthropic.com/en/api/getting-started
    - Troubleshooting: Rate limits, billing setup
  - [x] Add general troubleshooting section
  - [x] Add security best practices section (never commit `.env`, use secrets management)
  - [x] Add estimated total time: 60 minutes

- [ ] **Task 7: Validate All API Credentials** (AC: 7)
  - [ ] Test Google Calendar API:
    ```bash
    # Using gcloud CLI or Python script with service account
    python -c "from google.oauth2 import service_account; from googleapiclient.discovery import build; creds = service_account.Credentials.from_service_account_file('path/to/key.json', scopes=['https://www.googleapis.com/auth/calendar.readonly']); service = build('calendar', 'v3', credentials=creds); print(service.calendarList().list().execute())"
    ```
  - [ ] Test Stripe API:
    ```bash
    curl https://api.stripe.com/v1/customers \
      -u sk_test_your_secret_key: \
      -d "email=test@example.com"
    ```
  - [ ] Test Chatwoot API:
    ```bash
    curl https://app.chatwoot.com/api/v1/accounts/{ACCOUNT_ID}/conversations \
      -H "api_access_token: YOUR_TOKEN"
    ```
  - [ ] Test Anthropic Claude API (from Task 4)
  - [ ] Document validation results in setup guide
  - [ ] Verify all credentials stored securely (check `.gitignore` for `.env`)

- [ ] **Task 8: Configure Secure Credential Storage** (AC: 10)
  - [ ] Choose secure storage method: Password manager (1Password, LastPass) or secrets management tool (Vault, AWS Secrets Manager)
  - [ ] Create shared vault/folder: "Atrévete Bot API Credentials"
  - [ ] Store all API keys in secure vault with labels:
    - Google Service Account Email
    - Google Service Account JSON Key Path
    - Stripe Test Secret Key
    - Stripe Test Publishable Key
    - Stripe Production Secret Key (when obtained)
    - Stripe Production Publishable Key (when obtained)
    - Stripe Webhook Secret
    - Chatwoot API URL
    - Chatwoot API Token
    - Chatwoot Account ID
    - Chatwoot Inbox ID
    - Chatwoot Team Group ID
    - Anthropic API Key
  - [ ] Document access permissions: Which team members have access to test vs production keys
  - [ ] Share vault access with development team
  - [ ] Add reminder: Production keys should be kept separate from development keys

## Dev Notes

### Service Integration Overview

This story sets up the four critical external services that the Atrévete Bot depends on. These integrations enable the core functionality of the system.

[Source: architecture/3-tech-stack.md]

**External Services:**

1. **Google Calendar API** (`google-api-python-client>=2.150`)
   - **Purpose:** Event management for 5 stylist calendars
   - **Authentication:** Service account with domain-wide delegation
   - **Required Scopes:**
     - `https://www.googleapis.com/auth/calendar` (read/write calendar data)
     - `https://www.googleapis.com/auth/calendar.events` (manage events)
   - **Service Account:** Must be granted access to all 5 stylist Google Calendars

2. **Stripe API** (Python SDK `stripe>=10.0`)
   - **Purpose:** Payment links and webhook confirmations
   - **Authentication:** API keys (test + production)
   - **Webhook Events:**
     - `checkout.session.completed` (payment successful)
     - `charge.refunded` (refund processed)
   - **Security:** Webhook signature validation via `stripe.Webhook.construct_event()`

3. **Chatwoot API** (via `httpx`, no official SDK)
   - **Purpose:** WhatsApp message sending/receiving
   - **Authentication:** API access token
   - **Components Required:**
     - WhatsApp channel (requires Meta Business Manager)
     - API token (full permissions)
     - Account ID and Inbox ID
     - Team WhatsApp group conversation ID (for escalations)
   - **Webhook:** Incoming messages trigger `/webhook/chatwoot` endpoint

4. **Anthropic Claude API** (`anthropic>=0.40.0`)
   - **Purpose:** Natural language reasoning for conversation flow
   - **Model:** Claude Sonnet 4 for cost/performance balance
   - **Authentication:** API key (tier affects rate limits)
   - **Features Used:** 200k token context, tool use, Spanish fluency

### Security Requirements

[Source: architecture/security-and-performance.md, architecture/api-specification.md]

**Webhook Security:**
- **Chatwoot:** HMAC-SHA256 signature validation (X-Chatwoot-Signature header)
- **Stripe:** Stripe-Signature header validated via `stripe.Webhook.construct_event()`
- Both webhook endpoints return 401 Unauthorized if signature validation fails

**Credential Storage:**
- Environment secrets via `.env` file (NEVER committed to git)
- Production: Use Docker secrets or encrypted environment variable service
- `.gitignore` must include: `.env`, `*service-account*.json`, `*credentials*.json`

**Access Control:**
- Test API keys: Shared with all developers
- Production API keys: Limited to deployment/operations team only
- Service account JSON key: Stored securely, referenced by file path in environment

### Environment Variables Reference

All environment variables defined in this story will be used throughout the application. The definitive list is in `.env.example` created during Task 5.

**Critical Environment Variables:**

```bash
# Google Calendar API
GOOGLE_SERVICE_ACCOUNT_JSON=/path/to/service-account-key.json
GOOGLE_CALENDAR_IDS=comma,separated,calendar,ids,here

# Stripe
STRIPE_SECRET_KEY=sk_test_... (or sk_live_...)
STRIPE_PUBLISHABLE_KEY=pk_test_... (or pk_live_...)
STRIPE_WEBHOOK_SECRET=whsec_...
STRIPE_API_VERSION=2024-11-20.acacia

# Chatwoot
CHATWOOT_API_URL=https://app.chatwoot.com
CHATWOOT_API_TOKEN=...
CHATWOOT_ACCOUNT_ID=12345
CHATWOOT_INBOX_ID=67890
CHATWOOT_TEAM_GROUP_ID=conversation_id

# Anthropic
ANTHROPIC_API_KEY=sk-ant-...

# Application
TIMEZONE=Europe/Madrid
LOG_LEVEL=INFO
```

### Deployment Context

[Source: architecture/deployment-architecture.md]

**Production Webhook URLs:**
- Chatwoot webhook: `https://api.atrevete.com/webhook/chatwoot`
- Stripe webhook: `https://api.atrevete.com/webhook/stripe`

**Development Webhook URLs:**
- Local: `http://localhost:8000/webhook/chatwoot` and `/webhook/stripe`
- Testing: Use ngrok or webhook.site for local webhook testing

**Note:** Webhook URLs will be updated in:
- Chatwoot: Settings → Inboxes → {Inbox} → Webhook URL
- Stripe: Developers → Webhooks → Endpoint (Story 7.5)

### Prerequisites & Dependencies

**Prerequisites:** None - This is the FIRST story in Epic 1

**Dependent Stories:**
- Story 1.1 (Project Structure & Dependency Setup) requires the `.env.example` created in this story
- All future stories depend on these API credentials being available

### Validation Strategy

Since this is a setup story (no code), validation focuses on:
1. **API Connectivity:** All 4 services respond to test requests
2. **Webhook Testing:** Chatwoot and Stripe webhooks can receive and validate signatures
3. **Documentation Completeness:** Setup guide is clear and includes troubleshooting
4. **Secure Storage:** No credentials committed to git, `.gitignore` properly configured

**Acceptance Testing Checklist:**
- [ ] Can list Google Calendar events using service account
- [ ] Can create test Stripe charge using test API keys
- [ ] Can send WhatsApp message via Chatwoot API
- [ ] Can generate Claude completion via Anthropic API
- [ ] All credentials documented in setup guide
- [ ] `.env.example` contains all required variables with comments

### Testing

[Source: architecture/15-testing-strategy.md]

**Testing Approach for Story 0.1:**

This story creates no code, so traditional unit/integration tests are NOT applicable. Instead, validation is manual:

1. **Manual API Testing:**
   - Each service tested with `curl` or CLI tool (documented in Task 7)
   - Test results documented in setup guide

2. **Documentation Review:**
   - Setup guide reviewed for completeness and accuracy
   - Estimated times per service validated by tester

3. **Security Audit:**
   - Verify `.gitignore` excludes `.env` and credential files
   - Confirm no credentials in `.env.example` (only placeholders)
   - Validate secure storage method configured

**No automated tests required for this story.** Future stories will mock these APIs for testing.

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-24 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References
No debug issues encountered during documentation creation.

### Completion Notes
**Tasks Completed by Dev Agent:**
- **Task 5:** Created `.env.example` template with all required API credential placeholders, organized by service with helpful comments and acquisition URLs
- **Task 6:** Created comprehensive setup documentation guide (`docs/external-services-setup.md`) with step-by-step instructions for all 4 external services, troubleshooting sections, and security best practices
- Created `.gitignore` to ensure credentials are never committed to version control

**Tasks Requiring Manual Completion by User:**
- **Task 1:** Create Google Cloud project and service account (manual account setup required)
- **Task 2:** Create Stripe account and obtain API keys (manual account setup required)
- **Task 3:** Deploy Chatwoot instance and configure WhatsApp channel (manual deployment/configuration required)
- **Task 4:** Create Anthropic account and obtain API key (manual account setup required)
- **Task 7:** Validate all API credentials with real keys (requires completion of Tasks 1-4)
- **Task 8:** Configure secure credential storage (requires team's password manager setup)

**Next Steps:**
User should follow the setup guide (`docs/external-services-setup.md`) to complete manual service account creation tasks (Tasks 1-4, 7, 8).

### File List
**Created:**
- `.env.example` - Environment variable template with placeholders for all external service credentials
- `.gitignore` - Git ignore rules to prevent credential files from being committed
- `docs/external-services-setup.md` - Comprehensive setup guide with step-by-step instructions for all external services

## QA Results
_To be populated by QA Agent_
