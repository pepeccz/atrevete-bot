# Story 1.4c: Chatwoot Webhook Payload Structure Mismatch

**Fecha**: 2025-10-27
**Estado**: SOLUCIONADO
**Metodología**: BMAD (Behavior, Measure, Act, Document)

---

## B - BEHAVIOR (Análisis del Comportamiento)

### Síntomas Observados

1. **Peticiones reciben 400 Bad Request**:
   ```
   INFO: 172.20.0.1:48950 - "POST /webhook/chatwoot/j6gzStex3yw16AXBgzq3ARTq HTTP/1.1" 400 Bad Request
   ```

2. **Autenticación funciona**: El token en la URL se valida correctamente

3. **Error en validación de Pydantic**: La validación del payload JSON falla

### Causa Raíz Identificada

**El modelo Pydantic esperaba una estructura incorrecta**. Asumimos que Chatwoot enviaba un evento de mensaje directo, pero en realidad envía **la conversación completa con mensajes anidados**.

**Modelo INCORRECTO (lo que esperábamos)**:
```python
class ChatwootWebhookPayload(BaseModel):
    event: str                          # ← NO EXISTE en el payload real
    id: int                             # ← Este es conversation_id, no message_id
    content: str | None
    conversation: ChatwootConversation
    sender: ChatwootSender
    created_at: datetime
    message_type: str | None
```

**Payload REAL de Chatwoot**:
```json
{
  "id": 3,                    // ← conversation_id (NOT message_id)
  "inbox_id": 1,
  "additional_attributes": {},
  "can_reply": true,
  "channel": "Channel::Api",
  "contact_inbox": {...},
  "messages": [               // ← Array de mensajes (NO un mensaje directo)
    {
      "id": 606,             // ← message_id está AQUÍ
      "content": "Hola 3",
      "message_type": 0,     // ← 0 = incoming, 1 = outgoing
      "sender": {
        "phone_number": "+34623226544",
        "name": "Pepe Cabeza Personal"
      },
      "created_at": 1761603306,
      "conversation_id": 3
    }
  ],
  "meta": {...},
  "labels": [],
  "status": "open"
}
```

### Evidence

**Captura del Payload Real**:
```bash
$ docker compose logs api | grep "Body:"
{
  "id": 3,
  "inbox_id": 1,
  "messages": [{
    "id": 606,
    "content": "Hola 3",
    "message_type": 0,
    "sender": {
      "phone_number": "+34623226544",
      "name": "Pepe Cabeza Personal"
    }
  }]
}
```

---

## M - MEASURE (Medición)

### BEFORE (Estado Previo)

**Test**: POST al webhook con mensaje real de Chatwoot
**Resultado**: ❌ FAIL - HTTP 400 Bad Request
**Error**: Pydantic ValidationError (campos faltantes)

**Evidence**:
- Todos los mensajes de Chatwoot retornan 400
- Mi test manual con estructura incorrecta funcionó (falso positivo)
- Sistema completamente inoperativo con Chatwoot real

### AFTER (Estado Posterior)

**Test**: POST al webhook con estructura corregida
**Resultado**: ✅ PASS - HTTP 200 OK, mensaje procesado

**Evidence**:
```
INFO: 172.20.0.1:40014 - "POST /webhook/chatwoot/j6gzStex3yw16AXBgzq3ARTq HTTP/1.1" 200 OK
INFO: api.routes.chatwoot - Chatwoot message enqueued: conversation_id=3, phone=+34623226544
```

**Fecha de Verificación**: 2025-10-27 22:13:42 UTC
**Resultado**: Sistema completamente operativo con Chatwoot

---

## A - ACT (Acción Correctiva)

### Cambios Necesarios

**Archivo**: `api/models/chatwoot_webhook.py`

**ANTES**:
```python
class ChatwootWebhookPayload(BaseModel):
    event: str
    id: int
    content: str | None = None
    conversation: ChatwootConversation
    sender: ChatwootSender
    created_at: datetime
    message_type: str | None = Field(default=None)
```

**DESPUÉS**:
```python
class ChatwootMessage(BaseModel):
    """Single message within a Chatwoot conversation."""
    id: int
    content: str | None = None
    message_type: int  # 0 = incoming, 1 = outgoing
    sender: ChatwootSender
    created_at: int  # Unix timestamp
    conversation_id: int

class ChatwootWebhookPayload(BaseModel):
    """Chatwoot webhook payload - contains full conversation."""
    id: int  # conversation_id
    inbox_id: int
    messages: list[ChatwootMessage]
    # Other fields are optional for our use case
```

**Archivo**: `api/routes/chatwoot.py`

**Lógica de procesamiento**:
```python
# OLD (incorrecto):
if payload.event != "message_created":
    return ignore
if payload.message_type != "incoming":
    return ignore

# NEW (correcto):
# Procesar el último mensaje del array
if not payload.messages:
    return ignore

last_message = payload.messages[-1]  # Último mensaje
if last_message.message_type != 0:  # 0 = incoming
    return ignore
```

---

## D - DOCUMENT (Documentación)

### Lecciones Aprendidas

1. **NO asumir estructura de webhook sin verificar**: Siempre capturar payload real primero
2. **Logging de debug es esencial**: Sin él, hubiera sido imposible diagnosticar
3. **Ejemplos de docs pueden estar desactualizados**: El payload en `docs/chatwoot_textmessage.json` tenía estructura diferente (wrapper de n8n)

### Próximos Pasos

1. ✅ Actualizar modelo Pydantic
2. ✅ Actualizar lógica de procesamiento
3. ✅ Probar con mensaje real de Chatwoot
4. ✅ Eliminar endpoint de debug
5. ✅ Actualizar tests con estructura correcta
6. ✅ Actualizar documentación

### Referencias

- Chatwoot Webhook Documentation: https://www.chatwoot.com/docs/product/channels/api/webhooks
- Payload Real Capturado: Ver logs del 2025-10-27 22:05:52 UTC
