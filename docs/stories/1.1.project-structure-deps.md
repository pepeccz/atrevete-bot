# Story 1.1: Project Structure & Dependency Setup

## Status
Done

## Story
**As a** developer,
**I want** the project repository structure created with all Python dependencies properly configured,
**so that** I have a clean foundation to start building features without environment issues.

## Acceptance Criteria

1. Repository structure created with folders: `/api`, `/agent/graphs`, `/agent/state`, `/agent/tools`, `/agent/nodes`, `/agent/prompts`, `/database`, `/docker`, `/tests`, `/docs`
2. Python 3.11+ virtual environment configured
3. `requirements.txt` includes all dependencies: `langgraph>=0.6.7`, `langchain>=0.3.0`, `langchain-anthropic>=0.3.0`, `anthropic>=0.40.0`, `fastapi[standard]==0.116.1`, `uvicorn[standard]>=0.30.0`, `psycopg[binary]>=3.2.0`, `sqlalchemy>=2.0.0`, `alembic>=1.13.0`, `redis>=5.0.0`, `pydantic>=2.9.0`, `python-dotenv>=1.0.0`, `pytest>=8.3.0`, `pytest-asyncio>=0.24.0`
4. `.gitignore` configured to exclude `.env`, `__pycache__`, `.pytest_cache`, `venv/`, service account JSON keys
5. `.env.example` template created with all required environment variables documented (populated from Story 0.1)
6. `README.md` includes setup instructions for local development, referencing `docs/external-services-setup.md` for API key setup
7. All dependencies install successfully without version conflicts

## Tasks / Subtasks

- [x] **Task 1: Create Complete Project Directory Structure** (AC: 1)
  - [x] Create root folders: `/api`, `/agent`, `/admin`, `/database`, `/shared`, `/docker`, `/tests`, `/scripts`, `/docs`
  - [x] Create API subfolders: `/api/routes`, `/api/middleware`, `/api/models`
  - [x] Create Agent subfolders: `/agent/graphs`, `/agent/state`, `/agent/nodes`, `/agent/tools`, `/agent/prompts`, `/agent/workers`
  - [x] Create Admin subfolders: `/admin/templates/admin`, `/admin/static/admin/css`
  - [x] Create Database subfolders: `/database/alembic/versions`, `/database/seeds`
  - [x] Create Test subfolders: `/tests/unit`, `/tests/integration/scenarios`, `/tests/mocks`
  - [x] Create `__init__.py` files in all Python packages per structure [Source: architecture/11-unified-project-structure.md]

- [x] **Task 2: Configure Python Environment** (AC: 2)
  - [x] Create Python 3.11+ virtual environment using `python3.11 -m venv venv`
  - [x] Activate virtual environment
  - [x] Upgrade pip to version 24.0+: `pip install --upgrade pip` [Source: architecture/3-tech-stack.md#Build Tool]

- [x] **Task 3: Create Complete requirements.txt** (AC: 3, 7)
  - [x] Add core dependencies from Epic AC#3
  - [x] Add additional dependencies from architecture:
    - `httpx>=0.27.0` (async HTTP client) [Source: architecture/3-tech-stack.md#HTTP Client]
    - `django>=5.0` (admin panel) [Source: architecture/3-tech-stack.md#Frontend Framework]
    - `google-api-python-client>=2.150` (Calendar API) [Source: architecture/3-tech-stack.md#Calendar Integration]
    - `stripe>=10.0` (Payment processing) [Source: architecture/3-tech-stack.md#Payment Processing]
    - `tenacity` (retry logic) [Source: architecture/18-coding-standards.md#API Retries]
    - `phonenumbers` (phone normalization) [Source: architecture/18-coding-standards.md#Phone Normalization]
  - [x] Install all dependencies: `pip install -r requirements.txt`
  - [x] Verify no version conflicts in pip output
  - [x] Generate `requirements-frozen.txt` with exact versions: `pip freeze > requirements-frozen.txt`

- [x] **Task 4: Create .gitignore File** (AC: 4)
  - [x] Add `.env` to .gitignore
  - [x] Add `__pycache__/`, `*.pyc`, `*.pyo` to .gitignore
  - [x] Add `.pytest_cache/`, `.coverage`, `htmlcov/` to .gitignore
  - [x] Add `venv/`, `.venv/` to .gitignore
  - [x] Add service account JSON key patterns: `*service-account*.json`, `*credentials*.json`
  - [x] Add IDE-specific patterns: `.vscode/`, `.idea/`, `*.swp`
  - [x] Add `alembic.ini` database URL if contains credentials

- [x] **Task 5: Create .env.example Template** (AC: 5)
  - [x] Document all required environment variables with placeholders
  - [x] Add Google Calendar API variables: `GOOGLE_SERVICE_ACCOUNT_JSON`, `GOOGLE_CALENDAR_IDS` (comma-separated)
  - [x] Add Stripe variables: `STRIPE_SECRET_KEY`, `STRIPE_PUBLISHABLE_KEY`, `STRIPE_WEBHOOK_SECRET`, `STRIPE_API_VERSION`
  - [x] Add Chatwoot variables: `CHATWOOT_API_URL`, `CHATWOOT_API_TOKEN`, `CHATWOOT_ACCOUNT_ID`, `CHATWOOT_INBOX_ID`, `CHATWOOT_TEAM_GROUP_ID`
  - [x] Add Anthropic variables: `ANTHROPIC_API_KEY`
  - [x] Add Database variables: `DATABASE_URL` (PostgreSQL connection string)
  - [x] Add Redis variables: `REDIS_URL`
  - [x] Add application settings: `TIMEZONE=Europe/Madrid`, `LOG_LEVEL=INFO`
  - [x] Include comments with acquisition URLs for each service (reference Story 0.1 documentation)

- [x] **Task 6: Create README.md** (AC: 6)
  - [x] Add project title and brief description
  - [x] Add prerequisites section: Python 3.11+, Docker, external service accounts
  - [x] Add setup instructions:
    1. Clone repository
    2. Copy `.env.example` to `.env` and configure (reference `docs/external-services-setup.md`)
    3. Create virtual environment: `python3.11 -m venv venv`
    4. Activate virtual environment
    5. Install dependencies: `pip install -r requirements.txt`
  - [x] Add reference to `docs/external-services-setup.md` for API key setup
  - [x] Add quick start section for running services locally
  - [x] Add development workflow section placeholder
  - [x] Add links to documentation in `/docs` folder

- [x] **Task 7: Create pyproject.toml Configuration File**
  - [x] Add tool configurations for code quality tools:
    - `[tool.black]` for code formatting
    - `[tool.ruff]` for linting
    - `[tool.mypy]` for type checking
    - `[tool.pytest.ini_options]` for test configuration
  - [x] Configure pytest to use asyncio mode: `asyncio_mode = "auto"`
  - [x] Configure coverage minimum threshold: `--cov-fail-under=85` [Source: architecture/15-testing-strategy.md]

- [x] **Task 8: Validate Installation** (AC: 7)
  - [x] Run `pip check` to verify dependency compatibility
  - [x] Test imports: `python -c "import fastapi, langgraph, langchain, anthropic, sqlalchemy, redis, pytest"`
  - [x] Verify Python version: `python --version` (should show 3.11+)
  - [x] Document any version conflicts or warnings encountered

## Dev Notes

### Project Structure Notes

**⚠️ IMPORTANT: Architecture Supersedes Epic Requirements**

The Epic's AC#1 lists a minimal folder structure, but the architecture document defines a comprehensive structure that MUST be followed. The complete structure includes additional folders not mentioned in the Epic:

- `/admin` - Django Admin interface (not in Epic)
- `/shared` - Shared utilities and configuration (not in Epic)
- `/scripts` - Utility scripts for setup/deployment (not in Epic)
- `/agent/workers` - Background workers (not in Epic AC#1)

**Complete Structure to Implement:** [Source: architecture/11-unified-project-structure.md]

```
atrevete-bot/
├── .github/workflows/          # CI/CD (Story 1.6)
├── api/                        # FastAPI webhook receiver
│   ├── __init__.py
│   ├── main.py
│   ├── routes/
│   │   ├── __init__.py
│   │   ├── chatwoot.py
│   │   ├── stripe.py
│   │   └── health.py
│   ├── middleware/
│   │   ├── __init__.py
│   │   ├── signature_validation.py
│   │   └── rate_limiting.py
│   └── models/
│       ├── __init__.py
│       ├── chatwoot_webhook.py
│       └── stripe_webhook.py
├── agent/                      # LangGraph orchestrator
│   ├── __init__.py
│   ├── main.py
│   ├── graphs/
│   │   ├── __init__.py
│   │   └── conversation_flow.py
│   ├── state/
│   │   ├── __init__.py
│   │   └── schemas.py
│   ├── nodes/
│   │   ├── __init__.py
│   │   ├── identification.py
│   │   ├── classification.py
│   │   ├── availability.py
│   │   ├── booking.py
│   │   ├── payment.py
│   │   ├── modification.py
│   │   ├── cancellation.py
│   │   └── escalation.py
│   ├── tools/
│   │   ├── __init__.py
│   │   ├── calendar_tools.py
│   │   ├── payment_tools.py
│   │   ├── customer_tools.py
│   │   ├── booking_tools.py
│   │   └── notification_tools.py
│   ├── prompts/
│   │   └── maite_system_prompt.md
│   └── workers/
│       ├── __init__.py
│       ├── reminder_worker.py
│       ├── payment_timeout_worker.py
│       └── conversation_archiver.py
├── admin/                      # Django Admin interface
│   ├── __init__.py
│   ├── settings.py
│   ├── urls.py
│   ├── wsgi.py
│   ├── admin.py
│   ├── forms.py
│   ├── templates/
│   │   └── admin/
│   │       ├── base_site.html
│   │       └── appointment_calendar.html
│   └── static/
│       └── admin/
│           └── css/
│               └── custom.css
├── database/                   # SQLAlchemy models + migrations
│   ├── __init__.py
│   ├── models.py
│   ├── connection.py
│   ├── alembic/
│   │   ├── versions/
│   │   ├── env.py
│   │   └── alembic.ini
│   └── seeds/
│       ├── __init__.py
│       ├── stylists.py
│       ├── services.py
│       └── policies.py
├── shared/                     # Shared utilities
│   ├── __init__.py
│   ├── config.py
│   ├── logging_config.py
│   ├── redis_client.py
│   └── constants.py
├── docker/                     # Docker configurations
│   ├── Dockerfile.api
│   ├── Dockerfile.agent
│   ├── Dockerfile.admin
│   ├── docker-compose.yml
│   ├── docker-compose.prod.yml
│   └── nginx/
│       ├── nginx.conf
│       └── ssl/
├── tests/                      # Test suite
│   ├── __init__.py
│   ├── conftest.py
│   ├── unit/
│   │   ├── test_calendar_tools.py
│   │   ├── test_payment_tools.py
│   │   ├── test_customer_tools.py
│   │   └── test_booking_tools.py
│   ├── integration/
│   │   ├── test_api_webhooks.py
│   │   └── scenarios/
│   │       ├── test_scenario_01_new_booking.py
│   │       ├── test_scenario_02_modification.py
│   │       └── ...
│   └── mocks/
│       ├── mock_stripe.py
│       ├── mock_google_calendar.py
│       └── mock_chatwoot.py
├── scripts/                    # Utility scripts
│   ├── setup_db.sh
│   ├── seed_data.sh
│   ├── backup_db.sh
│   └── deploy.sh
├── docs/                       # Documentation
│   ├── brief.md
│   ├── prd/                    # Sharded PRD
│   ├── architecture/           # Sharded architecture
│   ├── stories/                # Story files
│   └── qa/                     # QA documentation
├── .env.example
├── .gitignore
├── requirements.txt
├── pyproject.toml
├── alembic.ini
├── README.md
└── LICENSE
```

### Complete Dependency List

**⚠️ Epic AC#3 is Incomplete**

The Epic lists core dependencies but omits several critical packages required by the architecture. The COMPLETE list includes:

[Source: architecture/3-tech-stack.md]

**Core Framework & Language:**
- `python>=3.11` (runtime requirement, not in requirements.txt)

**Agent & LLM:**
- `langgraph>=0.6.7` - Stateful conversation flow orchestration
- `langchain>=0.3.0` - Tool abstraction layer
- `langchain-anthropic>=0.3.0` - Claude SDK integration
- `anthropic>=0.40.0` - Anthropic API client

**API & Web Framework:**
- `fastapi[standard]==0.116.1` - Async API server (includes uvicorn)
- `uvicorn[standard]>=0.30.0` - ASGI server

**Database & ORM:**
- `psycopg[binary]>=3.2.0` - PostgreSQL adapter (async support)
- `sqlalchemy>=2.0.0` - ORM with async support
- `alembic>=1.13.0` - Database migrations

**Cache & Messaging:**
- `redis>=5.0.0` - In-memory cache and pub/sub

**Data Validation:**
- `pydantic>=2.9.0` - Data validation and settings

**Environment & Config:**
- `python-dotenv>=1.0.0` - Environment variable loading

**Testing:**
- `pytest>=8.3.0` - Test framework
- `pytest-asyncio>=0.24.0` - Async test support

**HTTP Client:**
- `httpx>=0.27.0` - Async HTTP client for external APIs

**Admin Panel:**
- `django>=5.0` - Admin interface framework

**External Service Integrations:**
- `google-api-python-client>=2.150` - Google Calendar API
- `stripe>=10.0` - Stripe payment API

**Utilities:**
- `tenacity` - Retry logic with exponential backoff [Source: architecture/18-coding-standards.md#API Retries]
- `phonenumbers` - E.164 phone number normalization [Source: architecture/18-coding-standards.md#Phone Normalization]

### Coding Standards to Follow

[Source: architecture/18-coding-standards.md]

**Critical Rules:**
- **Environment Variables:** Access ONLY via `shared/config.py`, NEVER use `os.getenv()` directly
- **Type Sharing:** Define shared types in `agent/state/schemas.py`, never duplicate
- **Phone Normalization:** Use `phonenumbers` library for E.164 format
- **Timezone:** All datetimes use `ZoneInfo("Europe/Madrid")`
- **API Retries:** Exponential backoff (3 attempts) via `tenacity` decorator

**Naming Conventions:**
- API Routes: `snake_case` (e.g., `/webhook/chatwoot`)
- Database Tables: `snake_case` (e.g., `appointments`)
- Python Functions: `snake_case` (e.g., `get_customer_by_phone()`)
- Python Classes: `PascalCase` (e.g., `ConversationState`)
- Environment Variables: `SCREAMING_SNAKE_CASE` (e.g., `STRIPE_SECRET_KEY`)

### Environment Variables Required

All environment variables must be documented in `.env.example` with comments. Required variables:

**Google Calendar API:**
- `GOOGLE_SERVICE_ACCOUNT_JSON` - Path to service account JSON key file
- `GOOGLE_CALENDAR_IDS` - Comma-separated calendar IDs for 5 stylists

**Stripe:**
- `STRIPE_SECRET_KEY` - Secret API key (test mode for development)
- `STRIPE_PUBLISHABLE_KEY` - Publishable API key
- `STRIPE_WEBHOOK_SECRET` - Webhook signing secret
- `STRIPE_API_VERSION` - API version (default to latest stable)

**Chatwoot:**
- `CHATWOOT_API_URL` - Chatwoot instance URL
- `CHATWOOT_API_TOKEN` - API access token
- `CHATWOOT_ACCOUNT_ID` - Account ID
- `CHATWOOT_INBOX_ID` - WhatsApp inbox ID
- `CHATWOOT_TEAM_GROUP_ID` - Team WhatsApp group conversation ID

**Anthropic:**
- `ANTHROPIC_API_KEY` - Claude API key

**Database:**
- `DATABASE_URL` - PostgreSQL connection string (format: `postgresql+asyncpg://user:pass@host:port/dbname`)

**Redis:**
- `REDIS_URL` - Redis connection string (format: `redis://host:port/db`)

**Application:**
- `TIMEZONE` - Default: `Europe/Madrid`
- `LOG_LEVEL` - Default: `INFO`

### Testing

[Source: architecture/15-testing-strategy.md]

**Test Organization:**
- Unit tests in `/tests/unit/` - Mock ALL external APIs (Google, Stripe, Chatwoot)
- Integration tests in `/tests/integration/` - Real FastAPI + Redis, mocked external APIs
- E2E scenario tests in `/tests/integration/scenarios/` - Full conversation flows

**Test Configuration (pyproject.toml):**
- Pytest asyncio mode: `asyncio_mode = "auto"`
- Coverage minimum: 85% (pipeline fails below threshold)
- Fixtures in `tests/conftest.py` for DB, Redis, API mocks

**Testing Standards:**
- All tests use `pytest` framework version 8.3.0+
- Async tests require `pytest-asyncio>=0.24.0`
- External API mocks stored in `/tests/mocks/`

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-24 | 1.0 | Initial story creation | Bob (Scrum Master) |
| 2025-10-25 | 1.1 | Story implementation completed - All 8 tasks finished, project structure and dependencies set up | James (Dev Agent) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References
No debug log entries required. All tasks completed successfully without issues.

### Completion Notes

**Summary:**
Successfully completed all 8 tasks for Story 1.1, establishing the complete project foundation with directory structure, Python environment, dependencies, and configuration files.

**Key Accomplishments:**
1. Created complete directory structure per architecture/11-unified-project-structure.md with 9 root folders and 20+ subfolders
2. Set up Python 3.12.3 virtual environment (exceeds 3.11+ requirement) with pip 25.3
3. Created requirements.txt with 27 direct dependencies and generated requirements-frozen.txt with exact versions
4. Verified existing .gitignore covers all requirements (already existed from previous work)
5. Verified existing .env.example is comprehensive (already existed from previous work)
6. Created comprehensive README.md with setup instructions and project overview
7. Created pyproject.toml with configurations for black, ruff, mypy, pytest, and coverage
8. Validated installation: all dependencies installed successfully, no conflicts, all imports work

**Validation Results:**
- `pip check`: No broken requirements found ✅
- Import test: All core packages import successfully ✅
- Python version: 3.12.3 (exceeds 3.11+ requirement) ✅
- Total dependencies installed: 100+ packages (27 direct + transitive)

**Notes:**
- Python 3.12.3 was available instead of 3.11, which is acceptable as it meets the 3.11+ requirement
- .gitignore and .env.example files already existed from previous setup work; validated they meet all story requirements
- No version conflicts encountered during dependency installation
- Project is ready for Story 1.2 (Docker Compose setup)

### File List

**Created Files:**
- `requirements.txt` - 27 direct dependencies with version constraints
- `requirements-frozen.txt` - Exact pinned versions of all 100+ installed packages
- `README.md` - Comprehensive project documentation and setup guide
- `pyproject.toml` - Tool configurations for black, ruff, mypy, pytest, coverage

**Verified Existing Files:**
- `.gitignore` - Comprehensive gitignore patterns (pre-existing, validated)
- `.env.example` - Environment variable template with all required vars (pre-existing, validated)

**Created Directories:**
- `api/` - FastAPI webhook receiver (with routes/, middleware/, models/ subfolders)
- `agent/` - LangGraph orchestrator (with graphs/, state/, nodes/, tools/, prompts/, workers/ subfolders)
- `admin/` - Django Admin interface (with templates/admin/, static/admin/css/ subfolders)
- `database/` - SQLAlchemy models & migrations (with alembic/versions/, seeds/ subfolders)
- `shared/` - Shared utilities and configuration
- `docker/` - Docker configurations (with nginx/ssl/ subfolder)
- `tests/` - Test suite (with unit/, integration/scenarios/, mocks/ subfolders)
- `scripts/` - Utility scripts
- `venv/` - Python virtual environment

**Created Python Package Files:**
- `__init__.py` files in: api/, api/routes/, api/middleware/, api/models/, agent/, agent/graphs/, agent/state/, agent/nodes/, agent/tools/, agent/prompts/, agent/workers/, admin/, database/, database/seeds/, shared/, tests/, tests/unit/, tests/integration/, tests/mocks/

## QA Results

### Review Date: 2025-10-25

### Reviewed By: Quinn (Test Architect)

**Summary:** Story 1.1 successfully establishes the complete project foundation with proper directory structure, Python environment, dependencies, and configuration files. All 7 acceptance criteria have been met with comprehensive implementation.

**Acceptance Criteria Assessment:**

1. ✅ **Repository Structure:** Complete directory structure created with all required folders (`/api`, `/agent`, `/database`, `/docker`, `/tests`, `/docs`) plus additional architecture-required folders (`/admin`, `/shared`, `/scripts`, `/agent/workers`). All Python packages include `__init__.py` files.

2. ✅ **Python Environment:** Python 3.12.3 virtual environment configured (exceeds 3.11+ requirement) with pip 25.3.

3. ✅ **Dependencies:** `requirements.txt` created with all 27 required dependencies including core packages (langgraph, langchain, fastapi, sqlalchemy, redis, pytest) and additional architecture-required packages (httpx, django, google-api-python-client, stripe, tenacity, phonenumbers). `requirements-frozen.txt` generated with exact versions.

4. ✅ **Gitignore:** Comprehensive `.gitignore` configured to exclude `.env`, `__pycache__`, `.pytest_cache`, `venv/`, and service account JSON keys.

5. ✅ **Environment Template:** `.env.example` created with all required environment variables documented (Google Calendar, Stripe, Chatwoot, Anthropic, Database, Redis, Application settings).

6. ✅ **README:** Comprehensive `README.md` includes setup instructions for local development with reference to `docs/external-services-setup.md` for API key setup.

7. ✅ **Installation Validation:** All dependencies install successfully with no version conflicts. Verified with `pip check` and import tests.

**Additional Quality Indicators:**

- ✅ **Tool Configuration:** `pyproject.toml` created with configurations for black, ruff, mypy, pytest, and coverage (85% threshold)
- ✅ **Documentation:** Extensive dev notes in story file documenting architecture supersedes, complete dependency list, coding standards, and testing requirements
- ✅ **Validation:** Thorough validation performed including `pip check`, import tests, and Python version verification

**Strengths:**

- Comprehensive implementation exceeding minimum requirements
- Excellent documentation in dev notes section
- Proper validation and testing of installation
- Clear changelog and completion notes
- Well-organized file structure following architecture specifications

### Gate Status

Gate: PASS → docs/qa/gates/1.1-project-structure-deps.yml
