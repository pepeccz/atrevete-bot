<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>1</storyId>
    <title>Migraci√≥n de Estados y Campos de Tracking</title>
    <status>drafted</status>
    <generatedAt>2025-11-19</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/1-1-migracion-de-estados-y-campos-de-tracking.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>desarrollador</asA>
    <iWant>actualizar el modelo de datos con nuevos estados y campos de tracking</iWant>
    <soThat>el sistema soporte el ciclo completo de confirmaci√≥n de citas</soThat>
    <tasks>
      <task id="1" title="Actualizar enum AppointmentStatus" ac="1">
        <subtask>1.1 Modificar database/models.py - enum con valores: PENDING, CONFIRMED, COMPLETED, CANCELLED, NO_SHOW</subtask>
        <subtask>1.2 Documentar cambio: CONFIRMED anterior ‚Üí PENDING (cita agendada esperando confirmaci√≥n)</subtask>
        <subtask>1.3 CONFIRMED nuevo = cliente verific√≥ asistencia</subtask>
      </task>
      <task id="2" title="Agregar campos timestamp a appointments" ac="2">
        <subtask>2.1 Agregar confirmation_sent_at: Mapped[datetime | None] - timestamp env√≠o plantilla 48h</subtask>
        <subtask>2.2 Agregar reminder_sent_at: Mapped[datetime | None] - timestamp env√≠o recordatorio 24h</subtask>
        <subtask>2.3 Agregar cancelled_at: Mapped[datetime | None] - timestamp cancelaci√≥n</subtask>
        <subtask>2.4 Agregar notification_failed: Mapped[bool] = False - flag si fall√≥ env√≠o</subtask>
      </task>
      <task id="3" title="Agregar campo a customers" ac="3">
        <subtask>3.1 Agregar chatwoot_conversation_id: Mapped[str | None] en Customer model</subtask>
      </task>
      <task id="4" title="Crear migraci√≥n Alembic" ac="1,2,3,4,5">
        <subtask>4.1 Ejecutar alembic revision --autogenerate -m "add_confirmation_tracking_fields"</subtask>
        <subtask>4.2 Revisar migraci√≥n generada - verificar cambios de enum</subtask>
        <subtask>4.3 Agregar SQL manual para √≠ndices parciales (autogenerate no los crea bien)</subtask>
        <subtask>4.4 Verificar funci√≥n downgrade() revierte correctamente</subtask>
      </task>
      <task id="5" title="Crear √≠ndices optimizados" ac="4">
        <subtask>5.1 √çndice idx_appointments_confirmation_pending (parcial: status='pending', confirmation_sent_at IS NULL)</subtask>
        <subtask>5.2 √çndice idx_appointments_customer_active (parcial: status IN ('pending', 'confirmed'))</subtask>
      </task>
      <task id="6" title="Testing" ac="1,2,3,4,5">
        <subtask>6.1 Aplicar migraci√≥n: alembic upgrade head</subtask>
        <subtask>6.2 Verificar columnas en DB: \d appointments, \d customers</subtask>
        <subtask>6.3 Verificar √≠ndices: \di+ idx_appointments_*</subtask>
        <subtask>6.4 Test downgrade: alembic downgrade -1</subtask>
        <subtask>6.5 Test upgrade de nuevo: alembic upgrade head</subtask>
        <subtask>6.6 Crear test unitario para verificar enum values</subtask>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <ac id="1">
      <description>El enum AppointmentStatus tiene valores: PENDING, CONFIRMED, COMPLETED, CANCELLED, NO_SHOW</description>
      <given>el esquema actual de base de datos</given>
      <when>se ejecuta la migraci√≥n de Alembic</when>
      <then>el enum tiene los 5 valores correctos</then>
    </ac>
    <ac id="2">
      <description>La tabla appointments tiene campos timestamp de tracking</description>
      <given>la migraci√≥n se ejecuta</given>
      <when>se inspecciona la tabla</when>
      <then>existen: confirmation_sent_at, reminder_sent_at, cancelled_at (nullable TIMESTAMP WITH TIME ZONE)</then>
      <and>existe: notification_failed (BOOLEAN default false)</and>
    </ac>
    <ac id="3">
      <description>La tabla customers tiene campo chatwoot_conversation_id</description>
      <given>la migraci√≥n se ejecuta</given>
      <when>se inspecciona la tabla</when>
      <then>existe columna chatwoot_conversation_id (VARCHAR nullable)</then>
    </ac>
    <ac id="4">
      <description>Existen √≠ndices optimizados para queries del worker</description>
      <given>la migraci√≥n se ejecuta</given>
      <when>se listan los √≠ndices</when>
      <then>existe idx_appointments_confirmation_pending (parcial: status='pending', confirmation_sent_at IS NULL)</then>
      <and>existe idx_appointments_customer_active (parcial: status IN ('pending', 'confirmed'))</and>
    </ac>
    <ac id="5">
      <description>La migraci√≥n es reversible</description>
      <given>la migraci√≥n se ha aplicado</given>
      <when>se ejecuta alembic downgrade -1</when>
      <then>el esquema vuelve al estado anterior sin errores</then>
    </ac>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture</title>
        <section>ADR-002: Renombrar Estados de Cita</section>
        <snippet>Renombrar CONFIRMED‚ÜíPENDING, crear nuevo CONFIRMED para verificadas. PENDING = esperando acci√≥n del cliente, CONFIRMED = cliente confirm√≥ asistencia.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture</title>
        <section>ADR-003: Campos Timestamp vs JSONB</section>
        <snippet>Usar campos timestamp dedicados (confirmation_sent_at, reminder_sent_at, cancelled_at). Razones: queries simples con √≠ndices, idempotencia natural (IS NULL), auditor√≠a clara.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture</title>
        <section>Data Architecture - Model Changes</section>
        <snippet>Appointment nuevos campos: confirmation_sent_at, reminder_sent_at, cancelled_at, notification_failed. Customer nuevo campo: chatwoot_conversation_id.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture</title>
        <section>Data Architecture - Indexes</section>
        <snippet>√çndices parciales: idx_appointments_confirmation_pending para queries del worker (status='pending'), idx_appointments_customer_active para citas activas.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture</title>
        <section>Novel Pattern: Async Confirmation Loop</section>
        <snippet>State Flow: PENDING ‚Üí confirmation_sent_at=NULL ‚Üí Worker 48h antes ‚Üí send_template() ‚Üí CONFIRMED (emoji üü¢) o CANCELLED (24h sin respuesta).</snippet>
      </doc>
      <doc>
        <path>docs/prd.md</path>
        <title>PRD</title>
        <section>Estados de Cita</section>
        <snippet>CONFIRMED=cita agendada (üü°), VERIFIED=cliente confirm√≥ (üü¢), CANCELLED, COMPLETED, NO_SHOW. Nota: Architecture ADR-002 define VERIFIED como CONFIRMED en c√≥digo.</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic Breakdown</title>
        <section>Story 1.1: Migraci√≥n de Estados y Campos de Tracking</section>
        <snippet>Technical Notes: Renombrar CONFIRMED‚ÜíPENDING en enum (ADR-002), campos timestamp nullable, √≠ndices parciales, migration reversible.</snippet>
      </doc>
    </docs>
    <code>
      <file>
        <path>database/models.py</path>
        <kind>models</kind>
        <symbol>AppointmentStatus</symbol>
        <lines>68-79</lines>
        <reason>Enum actual a modificar: PROVISIONAL, CONFIRMED, COMPLETED, CANCELLED, EXPIRED ‚Üí PENDING, CONFIRMED, COMPLETED, CANCELLED, NO_SHOW</reason>
      </file>
      <file>
        <path>database/models.py</path>
        <kind>models</kind>
        <symbol>Appointment</symbol>
        <lines>299-415</lines>
        <reason>Modelo principal a modificar: agregar campos timestamp (confirmation_sent_at, reminder_sent_at, cancelled_at, notification_failed)</reason>
      </file>
      <file>
        <path>database/models.py</path>
        <kind>models</kind>
        <symbol>Customer</symbol>
        <lines>158-234</lines>
        <reason>Modelo a modificar: agregar campo chatwoot_conversation_id para env√≠o de templates</reason>
      </file>
      <file>
        <path>database/connection.py</path>
        <kind>database</kind>
        <symbol>get_async_session</symbol>
        <lines>N/A</lines>
        <reason>Conexi√≥n de base de datos async - patr√≥n establecido para operaciones de DB</reason>
      </file>
    </code>
    <dependencies>
      <python>
        <package name="sqlalchemy" version=">=2.0.0">ORM para modelos y migraciones</package>
        <package name="alembic" version=">=1.13.0">Migraciones de base de datos</package>
        <package name="asyncpg" version=">=0.29.0">Driver PostgreSQL async</package>
        <package name="psycopg" version=">=3.2.0">Driver PostgreSQL sync (para migraciones)</package>
      </python>
      <database>
        <service name="PostgreSQL" version="15+">Base de datos principal con enums y JSONB</service>
      </database>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="pattern">Campos timestamp nullable para tracking (confirmation_sent_at, reminder_sent_at, cancelled_at) - ADR-003</constraint>
    <constraint type="pattern">√çndices parciales para queries del worker - optimizaci√≥n cr√≠tica para rendimiento NFR2</constraint>
    <constraint type="migration">Migraci√≥n reversible - funci√≥n downgrade() debe revertir todos los cambios</constraint>
    <constraint type="compatibility">Django Admin usa managed=False - no debe afectar modelos de core app</constraint>
    <constraint type="naming">Enum values en lowercase (pending, confirmed, etc.) - convenci√≥n establecida en proyecto</constraint>
    <constraint type="transition">Migrar datos existentes: UPDATE appointments SET status = 'pending' WHERE status = 'confirmed'</constraint>
    <constraint type="standard">TIMESTAMP WITH TIME ZONE para todos los campos datetime - patr√≥n establecido</constraint>
    <constraint type="coverage">Cobertura m√≠nima de tests: 85% - NFR10</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>AppointmentStatus Enum</name>
      <kind>Enum</kind>
      <signature>
class AppointmentStatus(PyEnum):
    PENDING = "pending"        # Cita agendada, esperando confirmaci√≥n
    CONFIRMED = "confirmed"    # Cliente confirm√≥ asistencia
    COMPLETED = "completed"
    CANCELLED = "cancelled"
    NO_SHOW = "no_show"
      </signature>
      <path>database/models.py</path>
    </interface>
    <interface>
      <name>Appointment Model - New Fields</name>
      <kind>SQLAlchemy Model</kind>
      <signature>
# Nuevos campos de tracking
confirmation_sent_at: Mapped[datetime | None]  # Timestamp env√≠o plantilla 48h
reminder_sent_at: Mapped[datetime | None]      # Timestamp env√≠o recordatorio 24h
cancelled_at: Mapped[datetime | None]          # Timestamp cancelaci√≥n
notification_failed: Mapped[bool] = False      # Flag si fall√≥ env√≠o
      </signature>
      <path>database/models.py</path>
    </interface>
    <interface>
      <name>Customer Model - New Field</name>
      <kind>SQLAlchemy Model</kind>
      <signature>
# Nuevo campo para templates
chatwoot_conversation_id: Mapped[str | None]  # ID conversaci√≥n en Chatwoot
      </signature>
      <path>database/models.py</path>
    </interface>
    <interface>
      <name>Partial Indexes for Worker</name>
      <kind>PostgreSQL Index</kind>
      <signature>
-- Para queries del worker
CREATE INDEX idx_appointments_confirmation_pending
ON appointments (start_time, confirmation_sent_at)
WHERE status = 'pending';

CREATE INDEX idx_appointments_customer_active
ON appointments (customer_id, start_time)
WHERE status IN ('pending', 'confirmed');
      </signature>
      <path>alembic migration</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Testing con pytest + pytest-asyncio en modo auto. Coverage m√≠nimo 85%. Tests unitarios para l√≥gica aislada, integration tests para componentes combinados. Los tests de modelos verifican que los campos existen y tienen tipos correctos. Los tests de migraci√≥n verifican upgrade/downgrade sin errores.
    </standards>
    <locations>
      <location>tests/unit/</location>
      <location>tests/integration/</location>
    </locations>
    <ideas>
      <idea ac="1">Test unitario que verifica AppointmentStatus enum tiene exactamente 5 valores: PENDING, CONFIRMED, COMPLETED, CANCELLED, NO_SHOW</idea>
      <idea ac="1">Test que verifica que NO existe PROVISIONAL ni EXPIRED en el enum</idea>
      <idea ac="2">Test de integraci√≥n que crea appointment y verifica campos timestamp son nullable y default None</idea>
      <idea ac="2">Test que verifica notification_failed tiene default False</idea>
      <idea ac="3">Test que verifica Customer model tiene chatwoot_conversation_id como string nullable</idea>
      <idea ac="4">Test de integraci√≥n que verifica √≠ndice idx_appointments_confirmation_pending existe y es parcial</idea>
      <idea ac="4">Test que verifica √≠ndice idx_appointments_customer_active existe y es parcial</idea>
      <idea ac="5">Test de migraci√≥n que ejecuta upgrade head, verifica esquema, luego downgrade -1 y verifica reversi√≥n</idea>
      <idea ac="1-5">Test de transici√≥n de datos: crear appointment con status='confirmed' (v3.2), ejecutar migraci√≥n, verificar status='pending'</idea>
    </ideas>
  </tests>
</story-context>
