<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>2</storyId>
    <title>Correcci√≥n de Herramienta book() con Emoji Calendar</title>
    <status>drafted</status>
    <generatedAt>2025-11-20</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/1-2-correccion-de-herramienta-book-con-emoji-calendar.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>cliente</asA>
    <iWant>que mi reserva se complete exitosamente</iWant>
    <soThat>pueda tener mi cita confirmada en el calendario del estilista</soThat>
    <tasks>
      - Task 1: Analizar error actual en book() (AC: 1, 6)
      - Task 2: Implementar transacci√≥n at√≥mica DB + Calendar (AC: 1, 2, 3, 6)
      - Task 3: Integrar creaci√≥n de evento Calendar con emoji (AC: 2, 3)
      - Task 4: Guardar chatwoot_conversation_id (AC: 4)
      - Task 5: Mejorar mensaje de confirmaci√≥n (AC: 5)
      - Task 6: Manejo de errores y mensajes claros (AC: 6)
      - Task 7: Testing unitario (AC: 1-6)
      - Task 8: Testing de integraci√≥n (AC: 1-6)
    </tasks>
  </story>

  <acceptanceCriteria>
    1. AC1: El sistema crea registro en tabla appointments con estado PENDING
       - Given el cliente ha seleccionado servicio, estilista y horario
       - When el sistema ejecuta la herramienta book()
       - Then se crea registro en BD con status='PENDING'
       - And los campos obligatorios est√°n poblados

    2. AC2: El sistema crea evento en Google Calendar con emoji üü° en t√≠tulo
       - Given el registro de cita se cre√≥ exitosamente en BD
       - When el sistema llama a Google Calendar API
       - Then se crea evento con t√≠tulo en formato üü° {first_name} - {service_name}
       - And el evento tiene descripci√≥n con servicios y notas
       - And la zona horaria es 'Europe/Madrid'

    3. AC3: El sistema guarda google_calendar_event_id en la cita
       - Given el evento de Calendar se cre√≥ exitosamente
       - When Calendar API retorna el event_id
       - Then se guarda en campo google_calendar_event_id de la cita

    4. AC4: El sistema guarda chatwoot_conversation_id en el customer
       - Given el sistema recibe el conversation_id del contexto
       - When ejecuta book()
       - Then actualiza campo chatwoot_conversation_id en la tabla customers

    5. AC5: El mensaje de confirmaci√≥n informa sobre confirmaci√≥n 48h antes
       - Given la cita se cre√≥ exitosamente
       - When el sistema retorna respuesta
       - Then el mensaje incluye informaci√≥n sobre confirmaci√≥n 48h antes
       - And el tono es amigable y profesional en espa√±ol

    6. AC6: Se hace rollback de transacci√≥n si falla Calendar
       - Given el registro de cita se cre√≥ en BD
       - When la creaci√≥n de evento en Calendar falla
       - Then se hace rollback de la transacci√≥n DB
       - And NO queda registro en tabla appointments
       - And se retorna mensaje de error claro con opci√≥n de reintentar
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture</title>
        <section>Novel Pattern: Async Confirmation Loop</section>
        <snippet>Patr√≥n para gestionar confirmaciones de citas con estado PENDING (agendada) que evoluciona a CONFIRMED (cliente confirm√≥). Define transacci√≥n at√≥mica DB + Calendar con rollback si falla Calendar (NFR5).</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture</title>
        <section>Implementation Patterns - Tool Response Format</section>
        <snippet>Formato est√°ndar para respuestas de tools: Success: {status: "success", message: str, data: dict}, Error: {status: "error", message: str, error_code: str}.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture</title>
        <section>Integration Points - Google Calendar</section>
        <snippet>Formato de evento Calendar con emoji visual para estados: üü° PENDING, üü¢ CONFIRMED. Zona horaria: Europe/Madrid. Event summary: f'üü° {first_name} - {service_names}'.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture</title>
        <section>ADR-002: Renombrar Estados de Cita</section>
        <snippet>PENDING = agendada esperando confirmaci√≥n (antes CONFIRMED), CONFIRMED = cliente confirm√≥ asistencia. Terminolog√≠a est√°ndar de la industria para confirmaci√≥n as√≠ncrona.</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic Breakdown</title>
        <section>Story 1.2: Correcci√≥n de Herramienta book() con Emoji Calendar</section>
        <snippet>Correcci√≥n cr√≠tica del flujo de agendamiento: crear cita con status PENDING, evento Calendar con emoji üü°, guardar google_calendar_event_id y chatwoot_conversation_id, transacci√≥n at√≥mica con rollback.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-1.md</path>
        <title>Epic Technical Specification: Epic 1</title>
        <section>APIs and Interfaces - book() Tool</section>
        <snippet>Contrato actualizado de book(): 7 pasos (validar inputs ‚Üí calcular duraci√≥n ‚Üí crear appointment PENDING ‚Üí guardar conversation_id ‚Üí crear Calendar ‚Üí guardar event_id ‚Üí commit). Timeout 3s con 1 retry.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-1.md</path>
        <title>Epic Technical Specification: Epic 1</title>
        <section>Reliability/Availability - Patr√≥n de transacci√≥n</section>
        <snippet>async with session.begin(): crear appointment ‚Üí flush ‚Üí crear Calendar (retry si falla) ‚Üí commit. Rollback autom√°tico por context manager si Calendar falla. SERIALIZABLE isolation.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/1-1-migracion-de-estados-y-campos-de-tracking.md</path>
        <title>Story 1.1: Migraci√≥n de Estados y Campos de Tracking</title>
        <section>Dev Notes - Learnings</section>
        <snippet>Migraci√≥n 62769e850a51 aplicada: AppointmentStatus.PENDING disponible, campos tracking (confirmation_sent_at, reminder_sent_at, cancelled_at, notification_failed) creados, Customer.chatwoot_conversation_id disponible.</snippet>
      </doc>
    </docs>

    <code>
      <artifact>
        <path>agent/tools/booking_tools.py</path>
        <kind>tool</kind>
        <symbol>book()</symbol>
        <lines>63-256</lines>
        <reason>Tool principal a modificar. Actualmente delega a BookingTransaction pero necesita integrar creaci√≥n de Calendar con emoji üü° y guardar google_calendar_event_id y chatwoot_conversation_id.</reason>
      </artifact>
      <artifact>
        <path>agent/transactions/booking_transaction.py</path>
        <kind>transaction</kind>
        <symbol>BookingTransaction.execute()</symbol>
        <lines>-</lines>
        <reason>Transacci√≥n at√≥mica donde se debe integrar Calendar API. Actualmente crea appointment en DB pero falta integraci√≥n Calendar con emoji y manejo de rollback.</reason>
      </artifact>
      <artifact>
        <path>database/models.py</path>
        <kind>model</kind>
        <symbol>AppointmentStatus</symbol>
        <lines>68-78</lines>
        <reason>Enum con valores PENDING, CONFIRMED actualizados en Story 1.1. Usar PENDING al crear citas.</reason>
      </artifact>
      <artifact>
        <path>database/models.py</path>
        <kind>model</kind>
        <symbol>Appointment</symbol>
        <lines>362-411</lines>
        <reason>Modelo con campos tracking disponibles: confirmation_sent_at, reminder_sent_at, cancelled_at, notification_failed. Tambi√©n tiene google_calendar_event_id (campo a poblar).</reason>
      </artifact>
      <artifact>
        <path>database/models.py</path>
        <kind>model</kind>
        <symbol>Customer</symbol>
        <lines>158-</lines>
        <reason>Modelo con campo chatwoot_conversation_id disponible (Story 1.1). Debe ser poblado en book() cuando se recibe del contexto.</reason>
      </artifact>
      <artifact>
        <path>shared/config.py</path>
        <kind>config</kind>
        <symbol>get_settings()</symbol>
        <lines>-</lines>
        <reason>Configuraci√≥n centralizada para environment variables. Usar para acceder a credenciales de Google Calendar (GOOGLE_APPLICATION_CREDENTIALS).</reason>
      </artifact>
    </code>

    <dependencies>
      <python>
        <package name="google-api-python-client" version=">=2.150">Google Calendar API integration</package>
        <package name="tenacity" version="latest">Retry logic para Calendar API</package>
        <package name="sqlalchemy" version=">=2.0.0">ORM con soporte async y transacciones</package>
        <package name="asyncpg" version=">=0.29.0">Driver PostgreSQL async</package>
        <package name="langchain-core" version=">=0.3.0">Tool definitions</package>
      </python>
    </dependencies>
  </artifacts>

  <constraints>
    - NFR5: Transacci√≥n DB primero, Calendar despu√©s (rollback si falla Calendar)
    - NFR3: Timeout Calendar de 3 segundos con 1 retry para errores transitorios
    - NFR1: Respuesta total debe ser menor a 5 segundos
    - Architecture Pattern: Tool Response Format con status/message/data
    - ADR-002: Usar status=PENDING al crear citas (no CONFIRMED)
    - Security: Service account key montado read-only en /app/service-account-key.json
    - Timezone: Todos los c√°lculos y eventos en Europe/Madrid
    - Emoji format: T√≠tulo Calendar debe ser exactamente 'üü° {first_name} - {service_names}'
    - Transactional isolation: Usar SERIALIZABLE para prevenir race conditions
    - Error messages: Espa√±ol, amigables, con opci√≥n de reintentar
    - Coverage: M√≠nimo 85% para c√≥digo nuevo (configurado en pyproject.toml)
  </constraints>

  <interfaces>
    <interface>
      <name>book() - Updated Contract</name>
      <kind>LangChain Tool</kind>
      <signature>
async def book(
    customer_id: str,
    first_name: str,
    last_name: str | None,
    notes: str | None,
    services: list[str],
    stylist_id: str,
    start_time: str
) -> dict[str, Any]
      </signature>
      <path>agent/tools/booking_tools.py:63-256</path>
    </interface>

    <interface>
      <name>Google Calendar API - Create Event</name>
      <kind>REST API</kind>
      <signature>
service.events().insert(
    calendarId=stylist.google_calendar_id,
    body={
        'summary': f'üü° {first_name} - {service_names}',
        'description': f'Servicios: {services}\nNotas: {notes}',
        'start': {'dateTime': start_time.isoformat(), 'timeZone': 'Europe/Madrid'},
        'end': {'dateTime': end_time.isoformat(), 'timeZone': 'Europe/Madrid'}
    }
).execute()
      </signature>
      <path>External: Google Calendar API v3</path>
    </interface>

    <interface>
      <name>BookingTransaction.execute()</name>
      <kind>Transaction Class</kind>
      <signature>
async def execute(
    customer_id: UUID,
    service_ids: list[UUID],
    stylist_id: UUID,
    start_time: datetime,
    first_name: str,
    last_name: str | None,
    notes: str | None
) -> dict
      </signature>
      <path>agent/transactions/booking_transaction.py</path>
    </interface>

    <interface>
      <name>Appointment Model</name>
      <kind>SQLAlchemy Model</kind>
      <signature>
class Appointment(Base):
    status: Mapped[AppointmentStatus]  # Set to PENDING
    google_calendar_event_id: Mapped[str | None]  # Populate after Calendar API
    confirmation_sent_at: Mapped[datetime | None]  # NULL initially
    reminder_sent_at: Mapped[datetime | None]  # NULL initially
    cancelled_at: Mapped[datetime | None]  # NULL initially
    notification_failed: Mapped[bool]  # Default False
      </signature>
      <path>database/models.py:362-411</path>
    </interface>

    <interface>
      <name>Customer Model - chatwoot_conversation_id</name>
      <kind>SQLAlchemy Model</kind>
      <signature>
class Customer(Base):
    chatwoot_conversation_id: Mapped[str | None]  # Populate from conversation context
      </signature>
      <path>database/models.py:158-</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      - Testing framework: pytest 8.3.0+ con pytest-asyncio 0.24.0+
      - Mode: asyncio_mode=auto (configurado en pyproject.toml)
      - Cobertura m√≠nima: 85% para c√≥digo nuevo
      - Unit tests: Mock Calendar API y DB para aislar l√≥gica
      - Integration tests: Usar Calendar API real en staging environment
      - Assertion style: pytest assertions con mensajes descriptivos
      - Fixture pattern: async fixtures para DB sessions
      - Coverage exclusions: admin/*, migrations, tests
    </standards>

    <locations>
      - tests/unit/test_booking_tools.py - Unit tests para book() tool
      - tests/integration/test_booking_flow.py - Integration tests de flujo completo
      - tests/mocks/ - Mock objects para Chatwoot y Google Calendar APIs
    </locations>

    <ideas>
      <test ac="AC1">
        <name>test_book_creates_appointment_with_pending_status</name>
        <description>Verificar que book() crea registro en appointments con status=PENDING y campos obligatorios poblados (customer_id, stylist_id, service_ids, start_time, end_time, first_name).</description>
      </test>
      <test ac="AC2">
        <name>test_book_creates_calendar_event_with_yellow_emoji</name>
        <description>Mockear Calendar API y verificar que se llama con t√≠tulo en formato 'üü° {first_name} - {service_names}', zona horaria Europe/Madrid, y descripci√≥n con servicios y notas.</description>
      </test>
      <test ac="AC3">
        <name>test_book_saves_google_calendar_event_id</name>
        <description>Verificar que despu√©s de crear evento en Calendar, el event_id retornado se guarda en campo google_calendar_event_id de la cita.</description>
      </test>
      <test ac="AC4">
        <name>test_book_saves_chatwoot_conversation_id_in_customer</name>
        <description>Verificar que book() actualiza campo chatwoot_conversation_id en customer con el valor recibido del contexto de conversaci√≥n.</description>
      </test>
      <test ac="AC5">
        <name>test_book_confirmation_message_includes_48h_info</name>
        <description>Verificar que el mensaje de respuesta exitosa incluye informaci√≥n sobre confirmaci√≥n 48h antes, en espa√±ol, tono amigable.</description>
      </test>
      <test ac="AC6">
        <name>test_book_rollback_on_calendar_error</name>
        <description>Mockear Calendar API para lanzar excepci√≥n. Verificar que la transacci√≥n DB hace rollback autom√°tico y NO queda registro en appointments. Mensaje de error claro con opci√≥n de reintentar.</description>
      </test>
      <test ac="AC2">
        <name>test_book_calendar_timeout_configured</name>
        <description>Verificar que Calendar API tiene timeout de 3 segundos configurado y retry 1x con tenacity para errores transitorios.</description>
      </test>
      <test ac="AC1-AC6">
        <name>test_booking_flow_end_to_end_integration</name>
        <description>Test de integraci√≥n completo: flujo de booking con Calendar API real (staging), verificar evento aparece en Google Calendar con emoji üü°, t√≠tulo correcto, zona horaria Europe/Madrid.</description>
      </test>
      <test ac="AC6">
        <name>test_rollback_when_calendar_unavailable</name>
        <description>Test de integraci√≥n: simular Calendar API no disponible, verificar rollback funciona y NO queda registro hu√©rfano en DB.</description>
      </test>
    </ideas>
  </tests>
</story-context>
