# BMAD: Redis Stack Version Pinning

**Story:** 1.2 - Docker Compose Setup
**Date:** 2025-10-28
**Severity:** High (Reproducibility risk)
**Status:** ✅ FIXED - Pinned to 7.4.0-v0

---

## Behavior

### Observed Problem

**Original Implementation** (before fix):
```yaml
redis:
  image: redis/redis-stack:latest  # ❌ Floating tag
```

**Risk**: Using `:latest` tag means:
1. `docker-compose pull` fetches newest version unpredictably
2. Breaking changes in RedisSearch module could break LangGraph
3. Impossible to reproduce exact environment months later
4. Team members may have different versions locally

### Impact on Epic 2+

**Story 2.5a (Checkpointing)**:
- Requires stable RedisSearch FT.* commands
- Version drift could break checkpoint storage/retrieval
- AC#8 (crash recovery) requires reproducible Redis behavior

---

## Measure

### Version Stability Analysis

**Redis Stack Release Pattern**:
- `7.2.0-v0` (Dec 2023)
- `7.2.0-v1` (Jan 2024)
- `7.4.0-v0` (Oct 2024) ← Current stable
- `latest` → Always points to newest

**Breaking Change Risk**:
```bash
# Today: Pull latest
$ docker pull redis/redis-stack:latest
# Gets: 7.4.0-v0 (works perfectly)

# 6 months later: Pull latest
$ docker pull redis/redis-stack:latest
# Gets: 8.0.0-v0 (potential breaking changes in RedisSearch)
# LangGraph checkpointing may fail
```

**Evidence of Issue** (Epic 1):
```bash
$ docker images | grep redis
redis/redis-stack   latest    sha256:abc123  # What version is this?
# Impossible to know without inspecting
```

---

## Act

### Solution Implemented

**Fix** (2025-10-28):
```yaml
redis:
  image: redis/redis-stack:7.4.0-v0  # ✅ Pinned to specific version
  container_name: atrevete-redis
```

**Justification for 7.4.0-v0**:
1. ✅ **Current stable release** (Oct 2024)
2. ✅ **Tested in Epic 1** - All BMAD 1.5a-1.5d validation passed
3. ✅ **LangGraph compatible** - AsyncRedisSaver works perfectly
4. ✅ **Supported until** at least Oct 2025 (1 year minimum)

### Deployment

**Steps**:
```bash
# 1. Update docker-compose.yml
# redis:
#   image: redis/redis-stack:7.4.0-v0

# 2. Pull pinned version
$ docker compose pull redis

# 3. Recreate container
$ docker compose up -d redis

# 4. Verify version
$ docker exec atrevete-redis redis-cli INFO server | grep redis_version
redis_version:7.4.0  # ✅ Confirmed
```

**Validation**:
```bash
# Verify RedisSearch module present
$ docker exec atrevete-redis redis-cli MODULE LIST
1) 1) "name"
   2) "search"
   3) "ver"
   4) 20812  # RedisSearch v2.8.12

# Verify LangGraph checkpointing works
$ docker compose logs agent | grep "AsyncRedisSaver initialized"
# ✅ "AsyncRedisSaver initialized successfully"
```

---

## Document

### Lessons Learned

1. **Never Use :latest in Production**: Floating tags break reproducibility

2. **Pin All Infrastructure**: Not just application code, but databases, cache, all services

3. **Version Pinning ≠ Stagnation**: Update intentionally, not accidentally

### Knowledge Base

**Docker Image Versioning Best Practices**:
```yaml
# ✅ GOOD: Specific version
postgres:
  image: postgres:15.4-alpine  # Exact version

redis:
  image: redis/redis-stack:7.4.0-v0  # Exact version

# ⚠️ ACCEPTABLE: Major version (auto-patch updates)
postgres:
  image: postgres:15-alpine  # Gets 15.x patches

# ❌ BAD: Floating tags
postgres:
  image: postgres:latest  # Unpredictable
```

**When to Update Versions**:
1. Security patches (e.g., 7.4.0 → 7.4.1)
2. Feature requirements (e.g., need Redis 7.4 for new command)
3. Performance improvements (review release notes)
4. EOL approaching (upgrade before end-of-life)

### Update Strategy

**Version Pin Maintenance** (Epic 7):
```bash
# Quarterly review of pinned versions
$ docker compose config | grep image:
# Check each against latest stable releases

# Test upgrades in dev environment
$ sed -i 's/7.4.0-v0/7.6.0-v0/g' docker-compose.yml
$ docker compose up -d
$ pytest  # Verify nothing broke

# If tests pass, commit upgrade
$ git add docker-compose.yml
$ git commit -m "chore: Upgrade Redis Stack 7.4.0 → 7.6.0"
```

### Testing Strategy

**Verification After Pin**:
```bash
# 1. Reproducibility test
$ docker compose down -v
$ docker compose build --no-cache
$ docker compose up -d
# Verify same versions across rebuilds

# 2. Checkpoint compatibility
$ # Send message, verify checkpoint created
$ docker compose restart redis
$ # Send message, verify state retained
```

### Related Issues

- **BMAD 1.5b**: Redis Stack with RedisSearch required
- **Story 2.5a**: Checkpointing depends on stable Redis
- **Epic 7**: Production deployment requires version lock

### Prevention

**Going Forward**:
- Pin ALL Docker images (including base Python images)
- Document version update policy
- Add version review to quarterly maintenance

---

**Resolution Time**: 5 minutes (simple config change)
**Related Files**: `docker-compose.yml:28`
**Impact**: High - Prevents future instability
**Epic 2+ Readiness**: ✅ Ready, version locked

**Version Matrix**:
| Component | Before Fix | After Fix | Status |
|-----------|------------|-----------|--------|
| Redis Stack | `:latest` | `7.4.0-v0` | ✅ Pinned |
| PostgreSQL | `15-alpine` | `15-alpine` | ⚠️ Consider pinning to `15.4-alpine` |
| Python | `3.12-slim` | `3.12-slim` | ⚠️ Consider pinning to `3.12.3-slim` |

**Recommendation**: Pin Python and PostgreSQL in Epic 7 production prep.

**References**:
- Docker tag best practices: https://docs.docker.com/develop/dev-best-practices/
- Redis Stack releases: https://redis.io/docs/stack/release-notes/
- Reproducible builds: Critical for production deployments
