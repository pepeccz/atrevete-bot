# BMAD: Docker 4-Service Architecture

**Story:** 1.2 - Docker Compose Setup
**Date:** 2025-10-28
**Severity:** Low (Architectural improvement)
**Status:** ✅ Implemented, superior to spec

---

## Behavior

### Observed Deviation

**Original Specification** (Story 1.2 AC#1):
> docker-compose.yml with 3 services: data (postgres + redis), api, agent

**Implemented**:
4 separate services in docker-compose.yml:
1. `postgres` - PostgreSQL 15 database
2. `redis` - Redis Stack 7.4.0 (pub/sub + checkpointing)
3. `api` - FastAPI webhook receiver (port 8000)
4. `agent` - LangGraph orchestrator + workers

---

## Measure

### Architectural Comparison

**3-Service Architecture** (as specified):
```yaml
services:
  data:  # Combined postgres + redis
    # Both databases in one container?
    # OR orchestrate two processes?

  api:
    depends_on: [data]

  agent:
    depends_on: [data, api]
```

**Problems with 3-Service**:
- ❌ How to run postgres + redis in single container? (requires supervisor)
- ❌ Can't restart one database without affecting the other
- ❌ Can't scale postgres independently from redis
- ❌ Health checks complicated (check both services)
- ❌ Logs mixed between two services

**4-Service Architecture** (as implemented):
```yaml
services:
  postgres:
    image: postgres:15-alpine
    healthcheck: pg_isready

  redis:
    image: redis/redis-stack:7.4.0-v0
    healthcheck: redis-cli ping

  api:
    depends_on:
      postgres: {condition: service_healthy}
      redis: {condition: service_healthy}

  agent:
    depends_on:
      postgres: {condition: service_healthy}
      redis: {condition: service_healthy}
      api: {condition: service_healthy}
```

**Benefits**:
- ✅ Each service in its own container (Docker best practice)
- ✅ Independent restart/scaling
- ✅ Clear dependency graph
- ✅ Separate health checks
- ✅ Isolated logs per service
- ✅ Future scalability (e.g., multiple agent workers)

---

## Act

### Implementation Details

**Dependency Graph**:
```
postgres ─┬─> api ──> agent
redis ────┘
```

**Service Breakdown**:

1. **postgres** (Data Layer):
   - Image: `postgres:15-alpine`
   - Port: 5432
   - Volume: `postgres_data` (persistence)
   - Health: `pg_isready`

2. **redis** (Cache + Pub/Sub):
   - Image: `redis/redis-stack:7.4.0-v0`
   - Port: 6379
   - Volume: `redis_data` (RDB persistence)
   - Health: `redis-cli ping`

3. **api** (Webhook Layer):
   - Build: `docker/Dockerfile.api`
   - Port: 8000 (exposed to host)
   - Depends: postgres, redis (healthy)
   - Health: `curl http://localhost:8000/health`

4. **agent** (Processing Layer):
   - Build: `docker/Dockerfile.agent`
   - No exposed ports (internal worker)
   - Depends: postgres, redis, api (all healthy)
   - Health: Python-based Redis ping

**Network**:
- Single `atrevete-network` (bridge driver)
- All services communicate via Docker DNS

### Benefits Realized

**Independent Operations**:
```bash
# Restart only Redis (doesn't affect API uptime)
$ docker compose restart redis

# Scale only agent workers (Epic 6+)
$ docker compose up -d --scale agent=3

# View logs per service
$ docker compose logs api
$ docker compose logs agent
```

**Future Scalability** (Epic 6-7):
- Multiple agent workers can share postgres + redis
- API can scale independently for webhook load
- Database/cache scaling separate from application scaling

---

## Document

### Lessons Learned

1. **One Process Per Container**: Docker best practice, avoid multi-process containers

2. **4-Service Better Than 3**: Separating postgres + redis simplifies everything

3. **Original Spec Ambiguity**: "data (postgres + redis)" was unclear - single container or grouped conceptually?

### Knowledge Base

**Recommended Docker Compose Pattern**:
```yaml
services:
  # Data layer (separate services)
  postgres:
    image: postgres:15
    volumes: [postgres_data:/var/lib/postgresql/data]
    healthcheck: [CMD, pg_isready]

  redis:
    image: redis:7-alpine
    volumes: [redis_data:/data]
    healthcheck: [CMD, redis-cli, ping]

  # Application layer
  api:
    build: ./api
    depends_on:
      postgres: {condition: service_healthy}
      redis: {condition: service_healthy}

  agent:
    build: ./agent
    depends_on:
      api: {condition: service_healthy}
```

**Anti-Pattern to Avoid**:
```yaml
# ❌ DON'T: Multiple processes in one container
data:
  image: custom-postgres-redis  # Requires supervisor, complex
  command: ["sh", "-c", "postgres & redis-server"]  # Process management issues
```

### Testing Strategy

**Validation**:
```bash
# Verify service independence
$ docker compose stop redis
$ docker compose ps
# Expect: postgres still running, api degraded, agent stopped

$ docker compose start redis
# Expect: api recovers, agent resumes
```

**Dependency Validation** (Epic 7):
```bash
# Test startup order
$ docker compose down -v
$ docker compose up -d
# Expect: postgres/redis → api → agent (sequential healthy startup)
```

### Related Issues

- **Story 1.2 AC#1**: Specified 3 services, 4 is better
- **Epic 6**: Horizontal scaling benefits from 4-service
- **Production**: Independent service management

### Prevention

**Going Forward**:
- Update PRD with actual architecture (4 services)
- Add architecture diagram to `docs/architecture.md`
- Document service dependencies clearly

---

**Resolution Time**: N/A (implemented during Story 1.2)
**Related Files**: `docker-compose.yml` (entire file)
**Impact**: Positive - Better architecture, scalability, maintainability
**Epic 2+ Readiness**: ✅ Ready, excellent foundation

**Architecture Diagram**:
```
┌─────────────────────────────────────────────────────────────┐
│                         atrevete-net                          │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐    │
│  │   API    │  │  Agent   │  │PostgreSQL│  │  Redis   │    │
│  │  :8000   │  │ (worker) │  │  :5432   │  │  :6379   │    │
│  │          │  │          │  │          │  │          │    │
│  │ Webhook  │  │ LangGraph│  │  Data    │  │Pub/Sub + │    │
│  │Receiver  │  │StateGraph│  │          │  │Checkpoint│    │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘    │
│       │             │              │              │          │
│       └─────Redis Pub/Sub─────────┴──────────────┘          │
└───────────────────────────────────────────────────────────────┘
```

**References**:
- Docker Compose best practices: One process per container
- 12-Factor App: https://12factor.net/processes
- Microservices patterns: Service independence
