# BMAD: Redis Stack Requirement for LangGraph AsyncRedisSaver

**Story:** 1.5 - Basic LangGraph State & Echo Bot
**Date:** 2025-10-28
**Severity:** Critical (Blocking)
**Status:** ✅ Resolved

---

## Behavior

### Observed Symptoms

After fixing the async context manager pattern (see `1.5a-asyncredissaver-initialization-pattern.md`), the agent still failed to initialize with a different error:

**Agent Container Test Output:**
```python
$ docker exec atrevete-agent python3 -c "
import asyncio
from langgraph.checkpoint.redis.aio import AsyncRedisSaver

async def test():
    async with AsyncRedisSaver.from_conn_string('redis://redis:6379/0') as saver:
        print('✓ AsyncRedisSaver initialized successfully')

asyncio.run(test())
"

# Output:
✗ AsyncRedisSaver failed: unknown command 'FT._LIST', with args beginning with:
```

**Full Error Traceback:**
```
Traceback (most recent call last):
  File "/usr/local/lib/python3.11/site-packages/langgraph/checkpoint/redis/aio.py", line 247, in asetup
    await self.checkpoints_index.create(overwrite=False)
  File "/usr/local/lib/python3.11/site-packages/redisvl/index/index.py", line 1338, in create
    if await self.exists():
  File "/usr/local/lib/python3.11/site-packages/redisvl/index/index.py", line 1877, in exists
    return self.schema.index.name in await self.listall()
  File "/usr/local/lib/python3.11/site-packages/redisvl/index/index.py", line 1869, in listall
    return convert_bytes(await client.execute_command("FT._LIST"))
redis.exceptions.ResponseError: unknown command 'FT._LIST'
```

### User Impact

- **Critical:** Agent unable to initialize even with correct async pattern
- **Symptoms:** AsyncRedisSaver setup fails immediately with Redis command error
- **Root Cause:** LangGraph's `AsyncRedisSaver` requires **RedisSearch module** (FT.* commands), which is not included in vanilla Redis

### Dependency Chain Analysis

**LangGraph Dependencies:**
```
langgraph.checkpoint.redis.aio.AsyncRedisSaver
    └─ uses redisvl.index.Index (RedisVL library)
        └─ requires RedisSearch module (FT.* commands)
            └─ NOT included in redis:7-alpine image
```

**RedisSearch Commands Used:**
- `FT._LIST` - List all search indexes
- `FT.CREATE` - Create search index
- `FT.SEARCH` - Search indexed data

These are part of the RedisSearch module, available in:
- Redis Stack (includes RedisSearch, RedisJSON, RedisGraph, etc.)
- Standalone RedisSearch module

---

## Measure

### Before Fix - Infrastructure

**File:** `docker-compose.yml:26-30`

```yaml
# Redis cache and pub/sub
redis:
  image: redis:7-alpine  # ❌ Vanilla Redis without modules
  container_name: atrevete-redis
  command: redis-server --save 900 1 --save 300 10 --save 60 10000 --appendonly no
  ports:
    - "6379:6379"
```

**Redis Capabilities (vanilla):**
```bash
$ docker exec atrevete-redis redis-cli COMMAND INFO FT._LIST
(error) ERR unknown command 'FT._LIST'
```

### Evidence of Module Requirement

**Test 1: Verify Redis connectivity works**
```python
$ docker exec atrevete-api python3 -c "
import asyncio
from redis.asyncio import Redis

async def test():
    client = Redis.from_url('redis://redis:6379/0')
    result = await client.ping()
    print(f'✓ Ping successful: {result}')
    await client.aclose()

asyncio.run(test())
"

# Output:
✓ Ping successful: True
```

**Test 2: Verify AsyncRedisSaver fails with vanilla Redis**
```python
# (Traceback shown in Behavior section above)
✗ AsyncRedisSaver failed: unknown command 'FT._LIST'
```

**Test 3: Verify API connection issues**
```bash
$ curl http://localhost:8000/health
{
    "status": "degraded",
    "redis": "disconnected",  # ❌ Connection reset by peer
    "postgres": "connected"
}
```

The API's rate limiting middleware also failed with:
```
ERROR: Rate limit check failed for IP 127.0.0.1: Connection reset by peer
```

This was due to the custom Redis command conflicting with redis-stack.

---

## Act

### Solution Implemented

**Strategy:** Replace vanilla Redis with Redis Stack image that includes all required modules.

**Changes Made:**

**File:** `docker-compose.yml:26-29`

```yaml
# Before (vanilla Redis):
redis:
  image: redis:7-alpine
  container_name: atrevete-redis
  command: redis-server --save 900 1 --save 300 10 --save 60 10000 --appendonly no

# After (Redis Stack):
# Redis cache and pub/sub (with RedisSearch for LangGraph checkpointer)
redis:
  image: redis/redis-stack:latest
  container_name: atrevete-redis
  # No custom command - use Redis Stack defaults
```

**Key Changes:**
- ✅ Changed image from `redis:7-alpine` to `redis/redis-stack:latest`
- ✅ Removed custom `command` that was incompatible with redis-stack
- ✅ Added comment documenting the RedisSearch requirement
- ✅ Preserved ports, volumes, network configuration

**Why Remove Custom Command?**

The original command:
```yaml
command: redis-server --save 900 1 --save 300 10 --save 60 10000 --appendonly no
```

Caused connection reset errors with redis-stack. Redis Stack has its own optimized configuration for modules. Using default configuration resolved the issue.

### Deployment

```bash
# Stop all services
docker compose stop redis agent api

# Remove old Redis container
docker compose rm -f redis

# Pull redis-stack and recreate all services
docker compose up -d

# Wait for Redis to initialize
sleep 10

# Verify Redis Stack modules loaded
docker exec atrevete-redis redis-cli MODULE LIST
```

**Expected Output:**
```
1) 1) "name"
   2) "search"
   3) "ver"
   4) 20812
   ...
```

### Validation Results

**Test 1: Verify FT._LIST command available**
```bash
$ docker exec atrevete-redis redis-cli FT._LIST
(empty array)  # ✅ Command exists (returns empty, which is expected)
```

**Test 2: Verify AsyncRedisSaver initialization**
```python
$ docker exec atrevete-agent python3 -c "
import asyncio
from langgraph.checkpoint.redis.aio import AsyncRedisSaver

async def test():
    try:
        async with AsyncRedisSaver.from_conn_string('redis://redis:6379/0') as saver:
            print('✓ AsyncRedisSaver initialized successfully')
            print(f'  Type: {type(saver)}')
    except Exception as e:
        print(f'✗ Error: {e}')

asyncio.run(test())
"

# Output:
✓ AsyncRedisSaver initialized successfully
  Type: <class 'langgraph.checkpoint.redis.aio.AsyncRedisSaver'>
```

**Test 3: Verify API Redis connection**
```bash
$ docker exec atrevete-api python3 -c "
import asyncio
from redis.asyncio import Redis

async def test():
    client = Redis.from_url('redis://redis:6379/0')
    await client.set('test_key', 'test_value')
    value = await client.get('test_key')
    print(f'✓ Set/Get successful: {value}')
    await client.aclose()

asyncio.run(test())
"

# Output:
✓ Set/Get successful: b'test_value'
```

**Test 4: Verify API health**
```bash
$ curl http://localhost:8000/health | python3 -m json.tool
{
    "status": "healthy",
    "redis": "connected",  # ✅ Now connected
    "postgres": "connected"
}
```

**Test 5: Verify Agent initialization**
```bash
$ docker compose logs agent --tail 10
{"timestamp": "2025-10-27T23:01:01.723374+00:00", "level": "INFO", "logger": "__main__", "message": "AsyncRedisSaver initialized successfully"}
{"timestamp": "2025-10-27T23:01:01.729940+00:00", "level": "INFO", "logger": "agent.graphs.conversation_flow", "message": "Conversation graph compiled with checkpointer=enabled"}
{"timestamp": "2025-10-27T23:01:01.735040+00:00", "level": "INFO", "logger": "__main__", "message": "Subscribed to 'incoming_messages' channel"}
```

✅ **All services healthy and agent fully initialized**

---

## Document

### Lessons Learned

1. **LangGraph Infrastructure Requirements:** LangGraph's Redis-based checkpointers are not compatible with vanilla Redis. They require RedisSearch module for indexing checkpoint metadata.

2. **Docker Image Selection:** When using libraries with specific Redis module requirements, always use `redis/redis-stack` instead of vanilla `redis:alpine`. Redis Stack includes:
   - RedisSearch (FT.* commands)
   - RedisJSON (JSON.* commands)
   - RedisGraph (GRAPH.* commands)
   - RedisTimeSeries (TS.* commands)
   - RedisBloom (BF.*, CF.*, etc.)

3. **Configuration Compatibility:** Custom Redis configurations (via `command:`) may conflict with Redis Stack's module initialization. Use default configuration unless specific tuning is required.

4. **Dependency Chains:** Library dependencies on Redis modules are not always obvious. Error messages like "unknown command 'FT._LIST'" are a clear indicator of missing modules.

### Knowledge Base

**Pattern:** Redis Stack for LangGraph Applications

**Correct docker-compose.yml:**
```yaml
services:
  redis:
    image: redis/redis-stack:latest
    container_name: my-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    # Use default configuration for modules
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
```

**Verification Commands:**
```bash
# Check modules loaded
docker exec <container> redis-cli MODULE LIST

# Test RedisSearch availability
docker exec <container> redis-cli FT._LIST

# Test basic operations
docker exec <container> redis-cli PING
```

### Compatibility Matrix

| Redis Image | RedisSearch | LangGraph AsyncRedisSaver | Use Case |
|-------------|-------------|---------------------------|----------|
| `redis:7-alpine` | ❌ No | ❌ Fails | Simple caching only |
| `redis:7` | ❌ No | ❌ Fails | Simple caching only |
| `redis/redis-stack:latest` | ✅ Yes | ✅ Works | LangGraph + caching |
| `redis/redis-stack-server:latest` | ✅ Yes | ✅ Works | Server-only (no RedisInsight) |

**Recommendation:** Use `redis/redis-stack:latest` for development, `redis/redis-stack-server:latest` for production (smaller image).

### Related Issues

- **Issue 1.5a:** AsyncRedisSaver async context manager pattern - see `1.5a-asyncredissaver-initialization-pattern.md`
- **Story 1.2 AC #8:** Redis persistence - Redis Stack includes RDB snapshots by default
- **Future:** Consider redis-stack-server for production to reduce image size

### Prevention

**Dependency Documentation:**
```python
# requirements.txt
langgraph>=0.6.7  # Requires Redis Stack (RedisSearch module)
```

**Infrastructure Requirements Document:**
```markdown
## Redis Requirements

LangGraph checkpointing requires Redis Stack with RedisSearch module.

**Docker Compose:**
- Image: `redis/redis-stack:latest` or `redis/redis-stack-server:latest`
- Do NOT use vanilla `redis:alpine` or `redis:latest`

**Managed Redis:**
- Ensure RedisSearch module enabled (e.g., Redis Cloud, AWS ElastiCache with Redis 7+)
- Verify with: `FT._LIST` command
```

**Pre-deployment Checklist:**
- [ ] Redis Stack image used in docker-compose.yml
- [ ] `FT._LIST` command returns successfully (even if empty)
- [ ] Agent initialization logs show "AsyncRedisSaver initialized successfully"
- [ ] Health check shows `redis: "connected"`

---

**Resolution Time:** ~1 hour (including Redis Stack download, testing, validation)
**Related Files:** `docker-compose.yml:26-43`
**Image Size Impact:**
- Before: `redis:7-alpine` (~30MB)
- After: `redis/redis-stack:latest` (~450MB)
- Acceptable for local development; consider `redis-stack-server` for production

**References:**
- Redis Stack documentation: https://redis.io/docs/stack/
- LangGraph checkpoint documentation
- RedisSearch module: https://redis.io/docs/stack/search/
